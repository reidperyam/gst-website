---
import type { Stat, Project } from '../../types/portfolio';
import '../../styles/portfolio-controls.css';

interface Props {
  portfolioType?: string;
  projects?: Project[];
}

const { portfolioType = 'standard', projects = [] } = Astro.props;

const title = portfolioType === 'ma' ? 'PORTFOLIO M&A ENGAGEMENTS' : 'CLIENT ENGAGEMENTS';

// Extract unique values for filters
const uniqueThemes = [...new Set(projects.map(p => p.theme))].sort();
const uniqueYears = [...new Set(projects.map(p => p.year))].sort((a, b) => b - a);

// Categorize growth stages
const growthKeywords = ['growth', 'expansion', 'small', 'scaling', 'scale-up', 'startup', 'early'];
const matureKeywords = ['mature', 'maturity', 'established', 'developed', 'legacy', 'modernizing', 'enterprise'];

const uniqueStages = [...new Set(projects.map(p => p.growthStage))];
const growthStages = uniqueStages.filter(s => growthKeywords.some(k => s.toLowerCase().includes(k))).sort();
const matureStages = uniqueStages.filter(s => matureKeywords.some(k => s.toLowerCase().includes(k))).sort();

// Categorize engagement types
const valueCreationTypes = ['Value Creation - Growth', 'Value Creation - Integration', 'Value Creation - Modernization', 'Value Creation - Turnaround'];
const technicalDiligenceTypes = ['Early Stage Assessment', 'Technical Assessment', 'Buy-Side Technical Diligence'];

const uniqueEngagementTypes = [
  ...new Set(
    projects
      .map(p => p.engagementType)
      .filter((e): e is Exclude<typeof e, undefined> => e !== undefined)
  )
].sort();
const valueCreationEngagements = uniqueEngagementTypes.filter(e => valueCreationTypes.includes(e)).sort();
const technicalDiligenceEngagements = uniqueEngagementTypes.filter(e => technicalDiligenceTypes.includes(e)).sort();
---

<div class="portfolio-header">
  <div class="container">
    <div class="portfolio-header-content">
      <div class="portfolio-brand">
        <h1 class="portfolio-title">{title}</h1>
      </div>

      <!-- Search and Filter Controls (Fixed) -->
      <div class="portfolio-controls-fixed">
        <div class="controls-wrapper">
          <div class="search-box">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input
              type="search"
              id="search-input-fixed"
              class="search-input"
              placeholder="Name, industry, or technology..."
              aria-label="Search projects"
              data-testid="portfolio-search-input"
            />
          </div>

          <button id="filter-toggle" class="filter-button" aria-label="Open filters" aria-expanded="false" data-testid="portfolio-filter-toggle">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="4" y1="6" x2="20" y2="6"></line>
              <line x1="4" y1="12" x2="20" y2="12"></line>
              <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
            <span class="filter-text">Filters</span>
            <span id="filter-badge-header" class="filter-badge" aria-live="polite" data-testid="portfolio-filter-badge"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Drawer (Slide-out) -->
  <div id="filter-drawer" class="filter-drawer portfolio-filter-drawer" data-testid="portfolio-filter-drawer">
    <div class="drawer-header">
      <h2 class="drawer-title">FILTERS</h2>
      <button id="drawer-close" class="drawer-close" aria-label="Close filters" data-testid="portfolio-drawer-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="drawer-content">
      <button id="clear-filters" class="clear-filters-button" data-testid="clear-filters-button">Clear All Filters</button>

      <div class="filter-section">
        <div class="filter-label">Company Growth Stage</div>
        <div class="filter-chips" id="stage-chips" data-testid="stage-filter-chips">
          <div class="filter-chip active" data-value="all" data-testid="filter-chip-stage-all">All Stages</div>
          <div class="filter-chip" data-value="growth-category" data-testid="filter-chip-stage-growth">Growth Stage</div>
          <div class="filter-chip" data-value="mature-category" data-testid="filter-chip-stage-mature">Mature Stage</div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Theme</div>
        <div class="filter-chips" id="theme-chips" data-testid="theme-filter-chips">
          <div class="filter-chip active" data-value="all" data-testid="filter-chip-theme-all">All Themes</div>
          {uniqueThemes.map(theme => (
            <div class="filter-chip" data-value={theme} data-testid={`filter-chip-theme-${theme.toLowerCase().replace(/\s+/g, '-')}`}>{theme}</div>
          ))}
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Year</div>
        <div class="filter-chips" id="year-chips" data-testid="year-filter-chips">
          <div class="filter-chip active" data-value="all" data-testid="filter-chip-year-all">All Years</div>
          {uniqueYears.map(year => (
            <div class="filter-chip" data-value={year.toString()} data-testid={`filter-chip-year-${year}`}>{year}</div>
          ))}
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Client Engagement</div>
        <div class="filter-chips" id="engagement-chips" data-testid="engagement-filter-chips">
          <div class="filter-chip active" data-value="all" data-testid="filter-chip-engagement-all">All Types</div>
          <div class="filter-chip" data-value="value-creation" data-testid="filter-chip-engagement-value-creation">Value Creation</div>
          <div class="filter-chip" data-value="technical-diligence" data-testid="filter-chip-engagement-technical-diligence">Technical Diligence</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Drawer Overlay (Mobile & Desktop) -->
  <div id="filter-overlay" class="filter-overlay portfolio-filter-overlay" data-testid="portfolio-filter-overlay"></div>
</div>

<style>
  /* Component-Specific Overrides */
  .portfolio-header {
    background: #ffffff;
    border-bottom: none;
    padding: 0.875rem 0;
  }

  .portfolio-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
  }

  .portfolio-brand {
    display: flex;
    align-items: center;
  }

  .portfolio-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: rgba(26, 26, 26, 0.95);
    text-transform: uppercase;
    letter-spacing: -0.02em;
    margin: 0;
    white-space: nowrap;
  }

  .portfolio-controls-fixed {
    background: #ffffff;
    border-bottom: none;
    padding: 0;
    height: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: position 0.2s ease-out, top 0.2s ease-out;
  }

  .portfolio-controls-fixed.sticky-active {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    width: fit-content;
    max-width: calc(100% - 3rem);
    z-index: 1002;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .portfolio-controls-fixed .container {
    width: fit-content;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    background: #ffffff;
  }


  .search-box {
    position: relative;
    flex: 1;
    min-width: 375px;
    display: flex;
    align-items: center;
    margin-left: 0rem;
  }

  .search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(26, 26, 26, 0.5);
    pointer-events: none;
    width: 18px;
    height: 18px;
  }

  .filter-badge {
    display: none;
    position: absolute;
    top: -8px;
    right: -8px;
    background: #05cd99;
    color: #ffffff;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: 50%;
    min-width: 20px;
    text-align: center;
    animation: badgePulse 0.3s ease-out;
  }

  @keyframes badgePulse {
    0% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .filter-text {
    display: inline;
  }

  .drawer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(26, 26, 26, 0.1);
    flex-shrink: 0;
  }

  .drawer-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: rgba(26, 26, 26, 0.95);
    margin: 0;
    letter-spacing: -0.01em;
  }

  .drawer-close {
    background: transparent;
    border: none;
    cursor: pointer;
    color: rgba(26, 26, 26, 0.6);
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .drawer-close:hover {
    color: #05cd99;
  }

  .drawer-close:focus-visible {
    outline: 2px solid #05cd99;
    outline-offset: 2px;
  }

  .drawer-content {
    padding: 1.5rem;
    flex: 1;
    overflow-y: auto;
  }

  .filter-section {
    margin-bottom: 1.5rem;
  }

  .filter-section:last-of-type {
    margin-bottom: 2rem;
  }

  .filter-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(26, 26, 26, 0.6);
    margin-bottom: 0.75rem;
  }

  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .clear-filters-button {
    width: calc(100% - 3rem);
    margin: 0 1.5rem 1.5rem 1.5rem;
  }

  /* Dark Theme Component Overrides */
  :global(html.dark-theme) .portfolio-header {
    background: #0a0a0a;
  }

  :global(html.dark-theme) .portfolio-controls-fixed {
    background: #1a1a1a;
  }

  :global(html.dark-theme) .portfolio-controls-fixed .container {
    background: #1a1a1a;
  }

  :global(html.dark-theme) .controls-wrapper {
    border-bottom-color: #05cd99;
  }

  :global(html.dark-theme) .portfolio-title {
    color: rgba(245, 245, 245, 0.95);
  }

  :global(html.dark-theme) .search-icon {
    color: rgba(200, 200, 200, 0.5);
  }

  :global(html.dark-theme) .portfolio-filter-drawer {
    background: #1a1a1a;
    border-left-color: #05cd99;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.4);
  }

  :global(html.dark-theme) .drawer-header {
    border-bottom-color: rgba(5, 205, 153, 0.2);
  }

  :global(html.dark-theme) .drawer-title {
    color: rgba(245, 245, 245, 0.95);
  }

  :global(html.dark-theme) .drawer-close {
    color: rgba(200, 200, 200, 0.6);
  }

  :global(html.dark-theme) .drawer-close:hover {
    color: #05cd99;
  }

  :global(html.dark-theme) .filter-label {
    color: rgba(200, 200, 200, 0.7);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .portfolio-header-content {
      gap: 1rem;
    }

    .portfolio-title {
      font-size: 1.25rem;
      letter-spacing: -0.01em;
    }

    .portfolio-controls-fixed {
      padding: 0.625rem 0;
    }

    .portfolio-controls-fixed.sticky-active {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      width: fit-content;
      max-width: calc(100% - 2rem);
      z-index: 1002;
    }

    .portfolio-controls-fixed .container {
      padding: 0.625rem 1rem;
    }

    .search-box {
      min-width: 270px;
    }

    .search-icon {
      left: 0.75rem;
      width: 16px;
      height: 16px;
    }

    .portfolio-filter-drawer {
      right: -100%;
      width: 100%;
      top: 133px;
      height: calc(100vh - 133px);
      border-left: none;
      border-top: 2px solid #05cd99;
    }

    .portfolio-filter-drawer.open {
      right: 0;
    }
  }

  @media (max-width: 480px) {
    .portfolio-header-content {
      gap: 0.75rem;
      flex-direction: column;
      align-items: flex-start;
    }

    .portfolio-title {
      font-size: 1.1rem;
    }

    .portfolio-controls-fixed {
      padding: 0.625rem 0;
      height: auto;
      width: 100%;
    }

    .portfolio-controls-fixed.sticky-active {
      position: fixed;
      left: 0;
      right: 0;
      transform: none;
      width: 100%;
      max-width: 100%;
      z-index: 1002;
    }

    .portfolio-controls-fixed .container {
      padding: 0 1.5rem;
      width: 100%;
    }


    .search-box {
      flex: 1;
      min-width: 0;
      min-height: 38px;
      display: flex;
      align-items: center;
    }

    .search-input {
      min-width: 0;
    }

    .search-icon {
      width: 16px;
      height: 16px;
      left: 0.65rem;
    }

    .filter-button {
      flex-shrink: 0;
      min-width: 44px;
      height: 38px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .filter-button svg {
      width: 20px;
      height: 20px;
    }

    .filter-text {
      display: none;
    }

    .portfolio-filter-drawer {
      right: -100%;
      bottom: 0;
      top: auto;
      width: 100%;
      height: auto;
      max-height: 85vh;
      border-left: none;
      border-top: 2px solid #05cd99;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
    }

    .drawer-header {
      padding: 1rem;
      flex-shrink: 0;
    }

    .drawer-content {
      padding: 1rem;
      max-height: calc(85vh - 60px);
      overflow-y: auto;
    }

    .filter-chips {
      gap: 0.625rem;
    }
  }
</style>

<script is:inline define:vars={{ projectsData: JSON.stringify(projects), growthStagesList: growthStages, matureStagesList: matureStages, valueCreationList: valueCreationEngagements, technicalDiligenceList: technicalDiligenceEngagements }}>
  // Initialize global state if it doesn't exist
  if (!window.portfolioState) {
    let allProjects = [];
    try {
      allProjects = JSON.parse(projectsData);
    } catch (e) {
      console.error('Failed to parse projects data:', e);
      allProjects = [];
    }

    window.portfolioState = {
      allProjects: allProjects,
      filteredProjects: [],
      filters: {
        search: '',
        stage: 'all',
        theme: 'all',
        year: 'all',
        engagement: 'all'
      },
      growthStages: growthStagesList,
      matureStages: matureStagesList,
      valueCreationEngagements: valueCreationList,
      technicalDiligenceEngagements: technicalDiligenceList
    };
  }

  let allProjects = window.portfolioState.allProjects;
  let filteredProjects = window.portfolioState.filteredProjects;
  let filters = window.portfolioState.filters;

  function filterProjects() {
    window.portfolioState.filteredProjects = allProjects.filter(project => {
      // Search filter
      if (filters.search) {
        const searchLower = filters.search.toLowerCase();
        const techs = Array.isArray(project.technologies)
          ? project.technologies
          : (typeof project.technologies === 'string'
              ? project.technologies.split(',').map(t => t.trim())
              : []);
        const searchableText = [
          project.codeName,
          project.industry,
          project.summary,
          ...techs
        ].join(' ').toLowerCase();

        if (!searchableText.includes(searchLower)) return false;
      }

      // Stage filter - handle category filtering
      if (filters.stage !== 'all') {
        if (filters.stage === 'growth-category') {
          if (!growthStagesList.includes(project.growthStage)) return false;
        } else if (filters.stage === 'mature-category') {
          if (!matureStagesList.includes(project.growthStage)) return false;
        } else if (project.growthStage !== filters.stage) {
          return false;
        }
      }

      // Theme filter
      if (filters.theme !== 'all' && project.theme !== filters.theme) return false;

      // Year filter
      if (filters.year !== 'all' && project.year.toString() !== filters.year) return false;

      // Engagement type filter - categorized by type
      if (filters.engagement !== 'all') {
        const valueCreationTypes = ['Value Creation - Growth', 'Value Creation - Integration', 'Value Creation - Modernization', 'Value Creation - Turnaround'];
        const technicalDiligenceTypes = ['Early Stage Assessment', 'Technical Assessment', 'Buy-Side Technical Diligence'];

        if (filters.engagement === 'value-creation') {
          if (!valueCreationTypes.includes(project.engagementType)) return false;
        } else if (filters.engagement === 'technical-diligence') {
          if (!technicalDiligenceTypes.includes(project.engagementType)) return false;
        }
      }

      return true;
    });

    filteredProjects = window.portfolioState.filteredProjects;
    updateGridDisplay();
    updateFilterBadge();
    window.dispatchEvent(new CustomEvent('portfolioFiltered', { detail: { count: filteredProjects.length } }));
  }

  function updateGridDisplay() {
    const cards = document.querySelectorAll('.project-card');
    let visibleCount = 0;

    cards.forEach(card => {
      const projectId = card.dataset.projectId;
      const isVisible = window.portfolioState.filteredProjects.some(p => p.id === projectId);

      if (isVisible) {
        card.style.display = '';
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.style.display = 'none';
        card.classList.add('hidden');
      }
    });

    // Show "no results" message if needed
    showNoResultsMessage(visibleCount === 0);
  }

  function showNoResultsMessage(show) {
    let message = document.getElementById('portfolio-no-results');

    if (show) {
      if (!message) {
        message = document.createElement('div');
        message.id = 'portfolio-no-results';
        message.className = 'no-results-message';
        message.textContent = 'No projects match your filters. Try adjusting your search or filters.';
        const grid = document.querySelector('.grid');
        if (grid && grid.parentElement) {
          grid.parentElement.insertBefore(message, grid);
        }
      }
      if (message) message.style.display = 'block';
    } else {
      if (message) message.style.display = 'none';
    }
  }

  function attachChipListeners() {
    const stageChipsContainer = document.getElementById('stage-chips');
    const themeChipsContainer = document.getElementById('theme-chips');
    const yearChipsContainer = document.getElementById('year-chips');
    const engagementChipsContainer = document.getElementById('engagement-chips');

    if (stageChipsContainer && !stageChipsContainer.hasListener) {
      stageChipsContainer.addEventListener('click', (e) => {
        const chip = e.target.closest('.filter-chip');
        if (chip) {
          document.querySelectorAll('#stage-chips .filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          filters.stage = chip.dataset.value;
          window.portfolioState.filters.stage = filters.stage;
          filterProjects();
        }
      });
      stageChipsContainer.hasListener = true;
    }

    if (themeChipsContainer && !themeChipsContainer.hasListener) {
      themeChipsContainer.addEventListener('click', (e) => {
        const chip = e.target.closest('.filter-chip');
        if (chip) {
          document.querySelectorAll('#theme-chips .filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          filters.theme = chip.dataset.value;
          window.portfolioState.filters.theme = filters.theme;
          filterProjects();
        }
      });
      themeChipsContainer.hasListener = true;
    }

    if (yearChipsContainer && !yearChipsContainer.hasListener) {
      yearChipsContainer.addEventListener('click', (e) => {
        const chip = e.target.closest('.filter-chip');
        if (chip) {
          document.querySelectorAll('#year-chips .filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          filters.year = chip.dataset.value;
          window.portfolioState.filters.year = filters.year;
          filterProjects();
        }
      });
      yearChipsContainer.hasListener = true;
    }

    if (engagementChipsContainer && !engagementChipsContainer.hasListener) {
      engagementChipsContainer.addEventListener('click', (e) => {
        const chip = e.target.closest('.filter-chip');
        if (chip) {
          document.querySelectorAll('#engagement-chips .filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          filters.engagement = chip.dataset.value;
          window.portfolioState.filters.engagement = filters.engagement;
          filterProjects();
        }
      });
      engagementChipsContainer.hasListener = true;
    }
  }

  function attachSearchListener() {
    const searchInput = document.getElementById('search-input-fixed');
    if (searchInput) {
      let searchTimeout;
      if (!searchInput.hasListener) {
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            filters.search = e.target.value;
            window.portfolioState.filters.search = filters.search;
            filterProjects();
          }, 300);
        });
        searchInput.hasListener = true;
      }
    }
  }

  function updateFilterBadge() {
    const headerBadge = document.getElementById('filter-badge-header');
    const stickyBadge = document.getElementById('filter-badge-sticky');
    const activeCount = Object.values(filters).filter(v => v !== 'all' && v !== '').length;

    if (headerBadge) {
      if (activeCount > 0) {
        headerBadge.style.display = 'inline-flex';
        headerBadge.textContent = activeCount;
      } else {
        headerBadge.style.display = 'none';
      }
    }

    if (stickyBadge) {
      if (activeCount > 0) {
        stickyBadge.style.display = 'inline-flex';
        stickyBadge.textContent = activeCount;
      } else {
        stickyBadge.style.display = 'none';
      }
    }
  }

  function openFilterDrawer() {
    const drawer = document.getElementById('filter-drawer');
    const overlay = document.getElementById('filter-overlay');
    const toggle = document.getElementById('filter-toggle');

    if (drawer && overlay && toggle) {
      drawer.classList.add('open');
      overlay.classList.add('open');
      toggle.setAttribute('aria-expanded', 'true');
    }
  }

  function closeFilterDrawer() {
    const drawer = document.getElementById('filter-drawer');
    const overlay = document.getElementById('filter-overlay');
    const toggle = document.getElementById('filter-toggle');

    if (drawer && overlay && toggle) {
      drawer.classList.remove('open');
      overlay.classList.remove('open');
      toggle.setAttribute('aria-expanded', 'false');
    }
  }

  function attachDrawerListeners() {
    const toggle = document.getElementById('filter-toggle');
    const closeBtn = document.getElementById('drawer-close');
    const overlay = document.getElementById('filter-overlay');
    const clearBtn = document.getElementById('clear-filters');

    if (toggle) {
      toggle.addEventListener('click', () => {
        const drawer = document.getElementById('filter-drawer');
        if (drawer && drawer.classList.contains('open')) {
          closeFilterDrawer();
        } else {
          openFilterDrawer();
        }
      });
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', closeFilterDrawer);
    }

    if (overlay) {
      overlay.addEventListener('click', closeFilterDrawer);
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        filters.search = '';
        filters.stage = 'all';
        filters.theme = 'all';
        filters.year = 'all';
        filters.engagement = 'all';
        window.portfolioState.filters = { ...filters };

        const searchInput = document.getElementById('search-input-fixed');
        if (searchInput) searchInput.value = '';
        document.querySelectorAll('.filter-chip.active').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('[data-value="all"]').forEach(c => c.classList.add('active'));

        filterProjects();
        updateFilterBadge();
      });
    }
  }

  function init() {
    attachChipListeners();
    attachSearchListener();
    attachDrawerListeners();
    filterProjects();
    updateFilterBadge();

    // Signal that portfolio is ready for interaction
    window.__portfolioInitialized = true;
    window.dispatchEvent(new CustomEvent('portfolioReady'));
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  window.portfolioFilters = {
    filterProjects,
    updateGridDisplay,
    attachChipListeners,
    openFilterDrawer,
    closeFilterDrawer,
    getFilteredProjects: () => window.portfolioState.filteredProjects,
    getFilters: () => window.portfolioState.filters
  };
</script>

<script>
  function initStickyControls() {
    const controlsElement = document.querySelector('.portfolio-controls-fixed') as HTMLElement | null;
    const headerElement = document.querySelector('.portfolio-header') as HTMLElement | null;
    const navHeader = document.querySelector('header') as HTMLElement | null;

    if (!controlsElement || !headerElement) {
      return;
    }

    let isSticky = false;

    function handleScroll() {
      if (!controlsElement || !headerElement) return;

      const headerRect = headerElement.getBoundingClientRect();
      const shouldBeSticky = headerRect.bottom <= 0;

      if (shouldBeSticky !== isSticky) {
        if (shouldBeSticky) {
          controlsElement.classList.add('sticky-active');
          const navHeight = navHeader ? navHeader.offsetHeight : 0;
          controlsElement.style.top = navHeight + 'px';
        } else {
          controlsElement.classList.remove('sticky-active');
          controlsElement.style.top = '';
        }
        isSticky = shouldBeSticky;
      }
    }

    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', handleScroll, { passive: true });

    handleScroll();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initStickyControls);
  } else {
    initStickyControls();
  }
</script>
