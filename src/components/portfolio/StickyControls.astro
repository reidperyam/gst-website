---
import type { Project } from '../../types/portfolio';

interface Props {
  projects: Project[];
}

const { projects } = Astro.props;

// Categorize growth stages
const growthKeywords = ['growth', 'expansion', 'small', 'scaling', 'scale-up', 'startup', 'early'];
const matureKeywords = ['mature', 'maturity', 'established', 'developed', 'legacy', 'modernizing', 'enterprise'];

const uniqueStages = [...new Set(projects.map(p => p.growthStage))];
const growthStages = uniqueStages.filter(s => growthKeywords.some(k => s.toLowerCase().includes(k))).sort();
const matureStages = uniqueStages.filter(s => matureKeywords.some(k => s.toLowerCase().includes(k))).sort();

// Extract unique values for filters
const uniqueThemes = [...new Set(projects.map(p => p.theme))].sort();
const uniqueYears = [...new Set(projects.map(p => p.year))].sort((a, b) => b - a);

// Categorize engagement types
const valueCreationTypes = ['Value Creation - Growth', 'Value Creation - Integration', 'Value Creation - Modernization', 'Value Creation - Turnaround'];
const technicalDiligenceTypes = ['Early Stage Assessment', 'Technical Assessment', 'Buy-Side Technical Diligence'];

const uniqueEngagementTypes = [...new Set(projects.map(p => p.engagementType).filter((e): e is string => e !== undefined))].sort();
const valueCreationEngagements = uniqueEngagementTypes.filter(e => valueCreationTypes.includes(e)).sort();
const technicalDiligenceEngagements = uniqueEngagementTypes.filter(e => technicalDiligenceTypes.includes(e)).sort();
---

<!-- Sticky Controls - Positioned independently at viewport level -->
<div class="sticky-controls-overlay">
  <div class="portfolio-controls-sticky">
    <div class="controls-wrapper">
      <div class="search-box">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input
          type="search"
          id="search-input"
          class="search-input"
          placeholder="Search by project name, technology, or industry..."
          aria-label="Search projects"
        />
      </div>

      <button id="filter-toggle-sticky" class="filter-toggle" aria-label="Open filters" aria-expanded="false">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="4" y1="6" x2="20" y2="6"></line>
          <line x1="4" y1="12" x2="20" y2="12"></line>
          <line x1="4" y1="18" x2="20" y2="18"></line>
        </svg>
        <span class="filter-text">Filters</span>
        <span id="filter-badge-sticky" class="filter-badge" aria-live="polite"></span>
      </button>
    </div>
  </div>
</div>

<style>
  /* Sticky Controls Overlay - Independent of page layout */
  .sticky-controls-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    width: 100%;
    z-index: 9999;
    pointer-events: auto;
  }

  /* Sticky Search/Filter Controls */
  .portfolio-controls-sticky {
    background: #ffffff;
    border-bottom: none;
    padding: 0;
    height: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease-out, opacity 0.2s ease-out;
    position: fixed;
    left: 50%;
    width: fit-content;
    max-width: calc(100% - 3rem);
    z-index: 1002;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    pointer-events: auto;
    top: 73px;
    transform: translateX(-50%) translateY(-200px);
    opacity: 0;
  }

  .portfolio-controls-sticky.sticky-active {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  .controls-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-bottom: 2px solid #05cd99;
    padding: 0.625rem 0 0.625rem 0;
    width: fit-content;
    pointer-events: auto;
  }

  .search-box {
    position: relative;
    flex: 1;
    min-width: 375px;
    display: flex;
    align-items: center;
    margin-left: 0.75rem;
  }

  .search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(26, 26, 26, 0.5);
    pointer-events: none;
    width: 18px;
    height: 18px;
  }

  .search-input {
    width: 100%;
    padding: 0.625rem 0.875rem 0.625rem 2.25rem;
    border: 1px solid rgba(26, 26, 26, 0.1);
    background: rgba(26, 26, 26, 0.02);
    color: rgba(26, 26, 26, 0.85);
    font-size: 0.8125rem;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    transition: all 0.2s;
    min-height: 38px;
  }

  .search-input:focus {
    outline: none;
    border-color: #05cd99;
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(5, 205, 153, 0.1);
  }

  .search-input::placeholder {
    color: rgba(26, 26, 26, 0.5);
  }

  .filter-toggle {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.75rem 1rem;
    margin-right: 0.75rem;
    background: rgba(26, 26, 26, 0.05);
    border: 1px solid rgba(26, 26, 26, 0.1);
    color: rgba(26, 26, 26, 0.7);
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    position: relative;
    min-height: 44px;
    pointer-events: auto;
  }

  .filter-toggle:hover {
    background: rgba(26, 26, 26, 0.08);
    border-color: #05cd99;
    color: #05cd99;
  }

  .filter-toggle:focus-visible {
    outline: 2px solid #05cd99;
    outline-offset: 2px;
  }

  .filter-toggle svg {
    pointer-events: auto;
  }

  .filter-text {
    display: inline;
  }

  .filter-badge {
    display: none;
    position: absolute;
    top: -8px;
    right: -8px;
    background: #05cd99;
    color: #ffffff;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: 50%;
    min-width: 20px;
    text-align: center;
    animation: badgePulse 0.3s ease-out;
  }

  @keyframes badgePulse {
    0% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .portfolio-filter-drawer {
    position: fixed;
    right: -400px;
    top: 80px;
    width: 350px;
    height: calc(100vh - 80px);
    background: #ffffff;
    border-left: 2px solid #05cd99;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
    transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10001;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    pointer-events: auto;
  }

  .portfolio-filter-drawer.open {
    right: 0;
  }

  .drawer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(26, 26, 26, 0.1);
    flex-shrink: 0;
  }

  .drawer-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: rgba(26, 26, 26, 0.95);
    margin: 0;
    letter-spacing: -0.01em;
  }

  .drawer-close {
    background: transparent;
    border: none;
    cursor: pointer;
    color: rgba(26, 26, 26, 0.6);
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .drawer-close:hover {
    color: #05cd99;
  }

  .drawer-close:focus-visible {
    outline: 2px solid #05cd99;
    outline-offset: 2px;
  }

  .drawer-content {
    padding: 1.5rem;
    flex: 1;
    overflow-y: auto;
  }

  .filter-section {
    margin-bottom: 1.5rem;
  }

  .filter-section:last-of-type {
    margin-bottom: 2rem;
  }

  .filter-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(26, 26, 26, 0.6);
    margin-bottom: 0.75rem;
  }

  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .chip {
    padding: 0.5rem 1rem;
    background: rgba(26, 26, 26, 0.05);
    color: rgba(26, 26, 26, 0.7);
    border: 1px solid rgba(26, 26, 26, 0.1);
    cursor: pointer;
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
  }

  .chip:hover {
    background: rgba(26, 26, 26, 0.08);
    border-color: #05cd99;
    color: #05cd99;
  }

  .chip.active {
    background: #05cd99;
    color: #ffffff;
    border-color: #05cd99;
  }

  .clear-filters-btn {
    width: calc(100% - 3rem);
    margin: 0 1.5rem 1.5rem;
    padding: 0.875rem 1rem;
    background: transparent;
    color: rgba(26, 26, 26, 0.6);
    border: 2px solid rgba(26, 26, 26, 0.1);
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 0;
  }

  .clear-filters-btn:hover {
    color: #05cd99;
    border-color: #05cd99;
  }

  .clear-filters-btn:focus-visible {
    outline: 2px solid #05cd99;
    outline-offset: 2px;
  }

  .portfolio-filter-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0);
    z-index: 10000;
    display: none;
    transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  .portfolio-filter-overlay.open {
    display: block;
    background: rgba(0, 0, 0, 0.3);
    pointer-events: auto;
  }

  /* Drawer container for proper z-index stacking */
  #filter-drawer,
  #filter-overlay {
    position: fixed !important;
  }

  /* Dark Theme */
  :global(body.dark-theme) .portfolio-controls-sticky {
    background: #1a1a1a;
  }

  :global(body.dark-theme) .controls-wrapper {
    border-bottom-color: #05cd99;
  }

  :global(body.dark-theme) .search-input {
    background: rgba(5, 205, 153, 0.05);
    border-color: rgba(5, 205, 153, 0.2);
    color: rgba(245, 245, 245, 0.85);
  }

  :global(body.dark-theme) .search-input:focus {
    background: #1a1a1a;
    border-color: #05cd99;
    box-shadow: 0 0 0 3px rgba(5, 205, 153, 0.15);
  }

  :global(body.dark-theme) .search-input::placeholder {
    color: rgba(200, 200, 200, 0.5);
  }

  :global(body.dark-theme) .search-icon {
    color: rgba(200, 200, 200, 0.5);
  }

  :global(body.dark-theme) .filter-toggle {
    background: rgba(5, 205, 153, 0.1);
    border-color: rgba(5, 205, 153, 0.2);
    color: rgba(200, 200, 200, 0.8);
  }

  :global(body.dark-theme) .filter-toggle:hover {
    background: rgba(5, 205, 153, 0.15);
    border-color: #05cd99;
    color: #05cd99;
  }

  :global(body.dark-theme) .portfolio-filter-drawer {
    background: #1a1a1a;
    border-left-color: #05cd99;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.4);
  }

  :global(body.dark-theme) .drawer-header {
    border-bottom-color: rgba(5, 205, 153, 0.2);
  }

  :global(body.dark-theme) .drawer-title {
    color: rgba(245, 245, 245, 0.95);
  }

  :global(body.dark-theme) .drawer-close {
    color: rgba(200, 200, 200, 0.6);
  }

  :global(body.dark-theme) .drawer-close:hover {
    color: #05cd99;
  }

  :global(body.dark-theme) .filter-label {
    color: rgba(200, 200, 200, 0.7);
  }

  :global(body.dark-theme) .chip {
    background: rgba(5, 205, 153, 0.1);
    border-color: rgba(5, 205, 153, 0.2);
    color: rgba(200, 200, 200, 0.8);
  }

  :global(body.dark-theme) .chip:hover {
    background: rgba(5, 205, 153, 0.15);
    border-color: #05cd99;
    color: #05cd99;
  }

  :global(body.dark-theme) .chip.active {
    background: #05cd99;
    color: #0a0a0a;
    border-color: #05cd99;
  }

  :global(body.dark-theme) .clear-filters-btn {
    color: rgba(200, 200, 200, 0.6);
    border-color: rgba(5, 205, 153, 0.2);
  }

  :global(body.dark-theme) .clear-filters-btn:hover {
    color: #05cd99;
    border-color: #05cd99;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .portfolio-controls-sticky {
      max-width: calc(100% - 2rem);
    }

    .search-box {
      min-width: 270px;
    }

    .portfolio-filter-drawer {
      right: -100%;
      width: 100%;
      height: calc(100vh - 80px);
      border-left: none;
      border-top: 2px solid #05cd99;
    }

    .portfolio-filter-drawer.open {
      right: 0;
    }
  }

  @media (max-width: 480px) {
    .portfolio-controls-sticky {
      max-width: min(75vw, calc(100% - 1.5rem));
    }

    .search-box {
      flex: 1;
      min-width: 200px;
      min-height: 38px;
      display: flex;
      align-items: center;
      margin-left: 1.5rem;
    }

    .search-input {
      padding: 0.625rem 0.75rem 0.625rem 2.25rem;
      font-size: 0.75rem;
      min-height: 38px;
      border-radius: 4px;
    }

    .search-icon {
      left: 0.75rem;
      width: 16px;
      height: 16px;
    }

    .filter-toggle {
      height: 38px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      min-width: unset;
      min-height: unset;
    }

    .filter-toggle svg {
      width: 18px;
      height: 18px;
    }

    .filter-text {
      display: none;
    }

    .portfolio-filter-drawer {
      right: -100%;
      bottom: 0;
      top: auto;
      width: 100%;
      height: auto;
      max-height: 85vh;
      border-left: none;
      border-top: 2px solid #05cd99;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
    }

    .portfolio-filter-drawer.open {
      right: 0;
    }

    .drawer-header {
      padding: 1rem;
      flex-shrink: 0;
    }

    .drawer-content {
      padding: 1rem;
      max-height: calc(85vh - 60px);
      overflow-y: auto;
    }

    .filter-chips {
      gap: 0.625rem;
    }

    .chip {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }
</style>

<script define:vars={{ projectsData: JSON.stringify(projects), growthStagesList: growthStages, matureStagesList: matureStages, valueCreationList: valueCreationEngagements, technicalDiligenceList: technicalDiligenceEngagements }}>
  // Initialize global state
  if (!window.portfolioState) {
    window.portfolioState = {
      allProjects: JSON.parse(projectsData),
      filteredProjects: [],
      filters: {
        search: '',
        stage: 'all',
        theme: 'all',
        year: 'all',
        engagement: 'all'
      },
      growthStages: growthStagesList,
      matureStages: matureStagesList,
      valueCreationEngagements: valueCreationList,
      technicalDiligenceEngagements: technicalDiligenceList
    };
  }

  let allProjects = window.portfolioState.allProjects;
  let filteredProjects = window.portfolioState.filteredProjects;
  let filters = window.portfolioState.filters;

  function filterProjects() {
    window.portfolioState.filteredProjects = allProjects.filter(project => {
      // Search filter
      if (filters.search) {
        const searchLower = filters.search.toLowerCase();
        const techs = Array.isArray(project.technologies)
          ? project.technologies
          : (typeof project.technologies === 'string'
              ? project.technologies.split(',').map(t => t.trim())
              : []);
        const searchableText = [
          project.codeName,
          project.industry,
          project.summary,
          ...techs
        ].join(' ').toLowerCase();

        if (!searchableText.includes(searchLower)) return false;
      }

      // Stage filter
      if (filters.stage !== 'all') {
        if (filters.stage === 'growth-category') {
          if (!growthStagesList.includes(project.growthStage)) return false;
        } else if (filters.stage === 'mature-category') {
          if (!matureStagesList.includes(project.growthStage)) return false;
        } else if (project.growthStage !== filters.stage) {
          return false;
        }
      }

      // Theme filter
      if (filters.theme !== 'all' && project.theme !== filters.theme) return false;

      // Year filter
      if (filters.year !== 'all' && project.year.toString() !== filters.year) return false;

      // Engagement type filter
      if (filters.engagement !== 'all') {
        const valueCreationTypes = ['Value Creation - Growth', 'Value Creation - Integration', 'Value Creation - Modernization', 'Value Creation - Turnaround'];
        const technicalDiligenceTypes = ['Early Stage Assessment', 'Technical Assessment', 'Buy-Side Technical Diligence'];

        if (filters.engagement === 'value-creation') {
          if (!valueCreationTypes.includes(project.engagementType)) return false;
        } else if (filters.engagement === 'technical-diligence') {
          if (!technicalDiligenceTypes.includes(project.engagementType)) return false;
        }
      }

      return true;
    });

    filteredProjects = window.portfolioState.filteredProjects;
    updateGridDisplay();
    updateFilterBadge();
    window.dispatchEvent(new CustomEvent('portfolioFiltered', { detail: { count: filteredProjects.length } }));
  }

  function updateGridDisplay() {
    const cards = document.querySelectorAll('.project-card');
    let visibleCount = 0;

    cards.forEach(card => {
      const projectId = card.dataset.projectId;
      const isVisible = window.portfolioState.filteredProjects.some(p => p.id === projectId);

      if (isVisible) {
        card.style.display = '';
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.style.display = 'none';
        card.classList.add('hidden');
      }
    });

    // Show "no results" message if needed
    showNoResultsMessage(visibleCount === 0);
  }

  function showNoResultsMessage(show) {
    let message = document.getElementById('portfolio-no-results');

    if (show) {
      if (!message) {
        message = document.createElement('div');
        message.id = 'portfolio-no-results';
        message.className = 'no-results-message';
        message.textContent = 'No projects match your filters. Try adjusting your search or filters.';
        const grid = document.querySelector('.grid');
        if (grid) grid.parentElement.insertBefore(message, grid);
      }
      message.style.display = 'block';
    } else {
      if (message) message.style.display = 'none';
    }
  }

  function attachChipListeners() {
    const stageChipsContainer = document.getElementById('stage-chips');
    const themeChipsContainer = document.getElementById('theme-chips');
    const yearChipsContainer = document.getElementById('year-chips');
    const engagementChipsContainer = document.getElementById('engagement-chips');

    if (stageChipsContainer && !stageChipsContainer.hasListener) {
      stageChipsContainer.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', function() {
          stageChipsContainer.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          filters.stage = chip.dataset.value;
          window.portfolioState.filters.stage = filters.stage;
          filterProjects();
        });
      });
      stageChipsContainer.hasListener = true;
    }

    if (themeChipsContainer && !themeChipsContainer.hasListener) {
      themeChipsContainer.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', function() {
          themeChipsContainer.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          filters.theme = chip.dataset.value;
          window.portfolioState.filters.theme = filters.theme;
          filterProjects();
        });
      });
      themeChipsContainer.hasListener = true;
    }

    if (yearChipsContainer && !yearChipsContainer.hasListener) {
      yearChipsContainer.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', function() {
          yearChipsContainer.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          filters.year = chip.dataset.value;
          window.portfolioState.filters.year = filters.year;
          filterProjects();
        });
      });
      yearChipsContainer.hasListener = true;
    }

    if (engagementChipsContainer && !engagementChipsContainer.hasListener) {
      engagementChipsContainer.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', function() {
          engagementChipsContainer.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          filters.engagement = chip.dataset.value;
          window.portfolioState.filters.engagement = filters.engagement;
          filterProjects();
        });
      });
      engagementChipsContainer.hasListener = true;
    }
  }

  function attachSearchListener() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      let searchTimeout;
      if (!searchInput.hasListener) {
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            filters.search = e.target.value;
            window.portfolioState.filters.search = filters.search;
            filterProjects();
          }, 300);
        });
        searchInput.hasListener = true;
      }
    }
  }

  function updateFilterBadge() {
    const headerBadge = document.getElementById('filter-badge-header');
    const stickyBadge = document.getElementById('filter-badge-sticky');
    const activeCount = Object.values(filters).filter(v => v !== 'all' && v !== '').length;

    if (headerBadge) {
      if (activeCount > 0) {
        headerBadge.style.display = 'inline-flex';
        headerBadge.textContent = activeCount;
      } else {
        headerBadge.style.display = 'none';
      }
    }

    if (stickyBadge) {
      if (activeCount > 0) {
        stickyBadge.style.display = 'inline-flex';
        stickyBadge.textContent = activeCount;
      } else {
        stickyBadge.style.display = 'none';
      }
    }
  }

  function attachDrawerListeners() {
    // Use event delegation on the document for click events
    document.addEventListener('click', (e) => {
      const toggle = e.target.closest('#filter-toggle-sticky');
      const closeBtn = e.target.closest('#drawer-close');
      const overlayClick = e.target.closest('#filter-overlay');

      // Get drawer and overlay each time to ensure they exist
      const drawer = document.getElementById('filter-drawer');
      const overlay = document.getElementById('filter-overlay');

      if (toggle) {
        e.preventDefault();
        e.stopPropagation();

        if (drawer && overlay) {
          const isOpen = drawer.classList.contains('open');
          if (isOpen) {
            drawer.classList.remove('open');
            overlay.classList.remove('open');
            toggle.setAttribute('aria-expanded', 'false');
            document.body.style.overflow = '';
          } else {
            drawer.classList.add('open');
            overlay.classList.add('open');
            toggle.setAttribute('aria-expanded', 'true');
            document.body.style.overflow = 'hidden';
          }
        }
      }

      if (closeBtn && drawer && overlay) {
        e.preventDefault();
        e.stopPropagation();
        drawer.classList.remove('open');
        overlay.classList.remove('open');
        const toggle2 = document.getElementById('filter-toggle-sticky');
        if (toggle2) {
          toggle2.setAttribute('aria-expanded', 'false');
        }
        document.body.style.overflow = '';
      }

      if (overlayClick && drawer && overlay) {
        e.preventDefault();
        e.stopPropagation();
        drawer.classList.remove('open');
        overlay.classList.remove('open');
        const toggle2 = document.getElementById('filter-toggle-sticky');
        if (toggle2) {
          toggle2.setAttribute('aria-expanded', 'false');
        }
        document.body.style.overflow = '';
      }
    });
  }

  function init() {
    attachChipListeners();
    attachSearchListener();
    attachDrawerListeners();
    filterProjects();
    updateFilterBadge();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Sticky behavior
  function handleStickyScroll() {
    const headerElement = document.querySelector('.portfolio-header');
    const controlsElement = document.querySelector('.portfolio-controls-sticky');
    const navHeader = document.querySelector('header');

    if (!headerElement || !controlsElement || !navHeader) return;

    const headerRect = headerElement.getBoundingClientRect();
    const navHeight = navHeader.offsetHeight;
    const shouldBeSticky = headerRect.bottom <= navHeight;

    if (shouldBeSticky) {
      controlsElement.classList.add('sticky-active');
      controlsElement.style.top = navHeight + 'px';
    } else {
      controlsElement.classList.remove('sticky-active');
      controlsElement.style.top = '';
    }
  }

  window.addEventListener('scroll', handleStickyScroll, { passive: true });
  window.addEventListener('resize', handleStickyScroll, { passive: true });
  handleStickyScroll();
</script>
