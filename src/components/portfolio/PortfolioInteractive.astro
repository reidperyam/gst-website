---
import type { Project } from '../../types/portfolio';

interface Props {
  projects: Project[];
}

const { projects } = Astro.props;
---

<script define:vars={{ projectsData: JSON.stringify(projects) }}>
  let allProjects = JSON.parse(projectsData);
  let filteredProjects = [...allProjects];
  let currentPage = 1;
  const itemsPerPage = 10;

  // Filter state
  const filters = {
    search: '',
    theme: 'all',
    stage: 'all',
    year: 'all'
  };

  // Sort state
  let sortColumn = null;
  let sortDirection = 'asc';

  // Initialize
  function init() {
    attachEventListeners();
    applyURLParams();
    renderTable();
  }

  // Apply URL parameters
  function applyURLParams() {
    const params = new URLSearchParams(window.location.search);
    filters.search = params.get('q') || '';
    filters.theme = params.get('theme') || 'all';
    filters.stage = params.get('stage') || 'all';
    filters.year = params.get('year') || 'all';
    currentPage = parseInt(params.get('page') || '1');

    // Update form inputs
    const searchInput = document.getElementById('search-input');
    const themeFilter = document.getElementById('theme-filter');
    const stageFilter = document.getElementById('stage-filter');
    const yearFilter = document.getElementById('year-filter');

    if (searchInput) searchInput.value = filters.search;
    if (themeFilter) themeFilter.value = filters.theme;
    if (stageFilter) stageFilter.value = filters.stage;
    if (yearFilter) yearFilter.value = filters.year;
  }

  // Update URL
  function updateURL() {
    const params = new URLSearchParams();
    if (filters.search) params.set('q', filters.search);
    if (filters.theme !== 'all') params.set('theme', filters.theme);
    if (filters.stage !== 'all') params.set('stage', filters.stage);
    if (filters.year !== 'all') params.set('year', filters.year);
    if (currentPage > 1) params.set('page', currentPage.toString());

    const newURL = `${window.location.pathname}?${params.toString()}`;
    window.history.replaceState({}, '', newURL);
  }

  // Filter projects
  function filterProjects() {
    filteredProjects = allProjects.filter(project => {
      // Search filter
      if (filters.search) {
        const searchLower = filters.search.toLowerCase();
        const techs = Array.isArray(project.technologies) ? project.technologies : (typeof project.technologies === 'string' ? project.technologies.split(',').map(t => t.trim()) : []);
        const searchableText = [
          project.codeName,
          project.industry,
          project.summary,
          ...techs
        ].join(' ').toLowerCase();

        if (!searchableText.includes(searchLower)) return false;
      }

      // Theme filter
      if (filters.theme !== 'all' && project.theme !== filters.theme) return false;

      // Stage filter
      if (filters.stage !== 'all' && project.growthStage !== filters.stage) return false;

      // Year filter
      if (filters.year !== 'all' && project.year.toString() !== filters.year) return false;

      return true;
    });

    currentPage = 1;
    updateURL();
  }

  // Sort projects
  function sortProjects(column) {
    if (sortColumn === column) {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      sortColumn = column;
      sortDirection = 'asc';
    }

    filteredProjects.sort((a, b) => {
      let valA, valB;

      switch (column) {
        case 'codeName':
          valA = a.codeName.toLowerCase();
          valB = b.codeName.toLowerCase();
          break;
        case 'theme':
          valA = a.theme.toLowerCase();
          valB = b.theme.toLowerCase();
          break;
        case 'arr':
          valA = a.arrNumeric;
          valB = b.arrNumeric;
          break;
        case 'growthStage':
          valA = a.growthStage.toLowerCase();
          valB = b.growthStage.toLowerCase();
          break;
        case 'year':
          valA = a.year;
          valB = b.year;
          break;
        default:
          return 0;
      }

      if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });

    renderTable();
  }

  // Paginate
  function paginate() {
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    return filteredProjects.slice(start, end);
  }

  function getTotalPages() {
    return Math.ceil(filteredProjects.length / itemsPerPage);
  }

  // Render table
  function renderTable() {
    const tbody = document.getElementById('portfolio-tbody');
    const paginatedProjects = paginate();

    if (paginatedProjects.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align: center; padding: 3rem 1.5rem; color: rgba(26, 26, 26, 0.65);">
            No projects match your filters. Try adjusting your search or filters.
          </td>
        </tr>
      `;
    } else {
      tbody.innerHTML = paginatedProjects
        .map(project => {
          // Ensure technologies is always an array
          const techs = Array.isArray(project.technologies) ? project.technologies : (typeof project.technologies === 'string' ? project.technologies.split(',').map(t => t.trim()) : []);

          return `
          <tr>
            <td>
              <div class="project-cell">
                <div class="project-title">${escapeHtml(project.codeName)}</div>
                <div class="project-subtitle">${escapeHtml(project.industry)}</div>
              </div>
            </td>
            <td><span class="theme-pill">${escapeHtml(project.theme)}</span></td>
            <td class="summary-cell">${escapeHtml(project.summary)}</td>
            <td class="arr-cell"><span class="arr-amount">${escapeHtml(project.arr)}</span></td>
            <td class="stage-cell">${escapeHtml(project.growthStage)}</td>
            <td class="year-cell">${project.year}</td>
            <td class="tech-cell">
              <div class="tech-tags">
                ${techs.map(tech => `<span class="tech-tag">${escapeHtml(tech)}</span>`).join('')}
              </div>
            </td>
          </tr>
        `;
        })
        .join('');
    }

    renderPagination();
    updateSortIndicators();
  }

  // Render pagination
  function renderPagination() {
    const totalPages = getTotalPages();
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const currentPageSpan = document.getElementById('current-page');
    const totalPagesSpan = document.getElementById('total-pages');

    if (currentPageSpan) currentPageSpan.textContent = currentPage.toString();
    if (totalPagesSpan) totalPagesSpan.textContent = totalPages.toString();

    if (prevBtn) {
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => changePage(currentPage - 1);
    }

    if (nextBtn) {
      nextBtn.disabled = currentPage === totalPages || totalPages === 0;
      nextBtn.onclick = () => changePage(currentPage + 1);
    }
  }

  // Change page
  window.changePage = function(newPage) {
    const totalPages = getTotalPages();
    if (newPage >= 1 && newPage <= totalPages) {
      currentPage = newPage;
      updateURL();
      renderTable();
      // Scroll to table
      document.querySelector('.portfolio-table-container')?.scrollIntoView({ behavior: 'smooth' });
    }
  };

  // Update sort indicators
  function updateSortIndicators() {
    document.querySelectorAll('.portfolio-table th.sortable').forEach(header => {
      header.classList.remove('sorted-asc', 'sorted-desc');
      if (header.dataset.column === sortColumn) {
        header.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
      }
    });
  }

  // Escape HTML
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }

  // Event listeners
  function attachEventListeners() {
    // Search input with debounce
    const searchInput = document.getElementById('search-input');
    let searchTimeout;
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          filters.search = e.target.value;
          filterProjects();
          renderTable();
        }, 300);
      });
    }

    // Dropdowns
    const themeFilter = document.getElementById('theme-filter');
    if (themeFilter) {
      themeFilter.addEventListener('change', (e) => {
        filters.theme = e.target.value;
        filterProjects();
        renderTable();
      });
    }

    const stageFilter = document.getElementById('stage-filter');
    if (stageFilter) {
      stageFilter.addEventListener('change', (e) => {
        filters.stage = e.target.value;
        filterProjects();
        renderTable();
      });
    }

    const yearFilter = document.getElementById('year-filter');
    if (yearFilter) {
      yearFilter.addEventListener('change', (e) => {
        filters.year = e.target.value;
        filterProjects();
        renderTable();
      });
    }

    // Sort headers
    document.querySelectorAll('.portfolio-table th.sortable').forEach(header => {
      header.style.cursor = 'pointer';
      header.addEventListener('click', () => {
        const column = header.dataset.column;
        if (column) {
          sortProjects(column);
        }
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
