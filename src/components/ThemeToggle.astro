---
// ThemeToggle.astro - Theme switcher component
import { trackThemeToggle } from '../utils/analytics';
---

<button class="theme-toggle" id="themeToggle" data-testid="theme-toggle" title="Toggle dark theme" aria-label="Toggle dark theme">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 48 88" aria-hidden="true">
        <text x="24" y="60" font-family="serif" font-size="57.6" fill="currentColor" text-anchor="middle">Î”</text>
    </svg>
</button>

<style>
    .theme-toggle svg text {
        transition: fill 0.3s ease;
    }

    :global(body.dark-theme) .theme-toggle svg text {
        fill: #05cd99;
    }
</style>

<script>
    import { trackThemeToggle } from '../utils/analytics';

    const themeToggle = document.getElementById('themeToggle');
    const htmlElement = document.documentElement;

    // Check for saved theme preference or default to light
    let currentTheme = 'light';
    try {
        currentTheme = localStorage.getItem('theme') || 'light';
    } catch (e) {
        console.error('Failed to access localStorage:', e);
        currentTheme = 'light';
    }

    if (currentTheme === 'dark') {
        document.body.classList.add('dark-theme');
    }

    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');

            try {
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            } catch (e) {
                console.error('Failed to save theme preference:', e);
            }

            // Track theme toggle in analytics
            trackThemeToggle(isDark ? 'dark' : 'light');
        });
    }
</script>
