---
// Google Analytics 4 Component
// Initializes GA4 tracking for the entire website
// Loads in production and test environments (test requests are mocked)
// Measurement ID should be provided via environment variable

const isProduction = import.meta.env.PROD;
const isTest = import.meta.env.MODE === 'test' ||
               typeof process !== 'undefined' && process.env.VITEST;
const enableAnalytics = (isProduction || isTest) &&
                       import.meta.env.PUBLIC_ENABLE_ANALYTICS !== 'false';
const loadExternalScript = isProduction; // Only load GA script in production
const measurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID || 'G-WTGM9Y1YB0';
---

{enableAnalytics && (
  <>
    <script define:vars={{ measurementId }} is:inline>
      // Load Google Analytics
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', measurementId, {
        send_page_view: true,
      });

      // Expose gtag globally for event tracking
      window.gtag = gtag;
    </script>

    {loadExternalScript && (
      <script
        async
        is:inline
        src={`https://www.googletagmanager.com/gtag/js?id=${measurementId}`}
      ></script>
    )}
  </>
)}
