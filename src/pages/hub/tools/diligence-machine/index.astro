---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { WIZARD_STEPS } from '../../../../data/diligence-machine/wizard-config';
import { trackPageView } from '../../../../utils/analytics';

trackPageView('diligence-machine', 'The Diligence Machine | GST');
---

<BaseLayout
    title="The Diligence Machine | Strategic Intelligence Hub"
    description="Generate a simple technology due diligence agenda customized to your target's profile. 15-20 high-impact questions organized by topic."
    ogTitle="The Diligence Machine | GST"
    ogDescription="Customize a technology diligence checklist by target parameters. Risk-prioritized, executive-ready."
    ogImage="/og-image.png"
    ogUrl="https://globalstrategic.tech/hub/tools/diligence-machine"
>
    <section class="diligence-machine">
        <div class="container">
            <!-- Header -->
            <header class="dm-header">
                <span class="section-label">Tools</span>
                <h1>The Diligence Machine</h1>
                <p class="dm-subtitle">Generate a prescriptive technology due diligence agenda customized to your target's profile.</p>
            </header>

            <!-- Wizard Container -->
            <div class="wizard-container" id="wizardContainer">
                <!-- Progress Bar -->
                <div class="wizard-progress" role="progressbar" aria-valuemin="1" aria-valuemax="5" aria-valuenow="1" aria-label="Wizard progress">
                    {WIZARD_STEPS.map((step, index) => (
                        <div class={`progress-segment ${index === 0 ? 'active' : ''}`} data-step-indicator={index + 1}>
                            <svg class="progress-number" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M32 12 L52 52 L12 52 Z" fill="none" stroke="currentColor" stroke-width="5.5" stroke-linejoin="miter" />
                                <text x="32" y="40" text-anchor="middle" dominant-baseline="middle" class="progress-number-text">{index + 1}</text>
                            </svg>
                            <span class="progress-label">{step.title}</span>
                        </div>
                    ))}
                </div>

                <!-- Steps -->
                <div class="wizard-steps">
                    {WIZARD_STEPS.map((step, index) => (
                        <div
                            class={`wizard-step ${index === 0 ? 'active' : ''}`}
                            data-step={index + 1}
                            data-step-id={step.id}
                            data-input-type={step.inputType}
                        >
                            <h2 class="step-title">{step.title}</h2>
                            <p class="step-subtitle">{step.subtitle}</p>

                            {step.inputType === 'single-select' && step.options && (
                                <div class="options-grid">
                                    {step.options.map((option) => (
                                        <button
                                            class="option-card"
                                            data-option-id={option.id}
                                            data-step-id={step.id}
                                            type="button"
                                            aria-pressed="false"
                                        >
                                            <span class="option-label"><img src="/images/gst-delta-icon-teal-stroke-thick.svg" alt="" aria-hidden="true" class="option-icon" width="10" height="10" />{option.label}</span>
                                            {option.description && (
                                                <span class="option-description">{option.description}</span>
                                            )}
                                        </button>
                                    ))}
                                </div>
                            )}

                            {step.inputType === 'multi-select' && step.options && (
                                <div class="options-grid">
                                    {step.options.map((option) => (
                                        <button
                                            class="option-card"
                                            data-option-id={option.id}
                                            data-step-id={step.id}
                                            type="button"
                                            aria-pressed="false"
                                        >
                                            <span class="option-label"><img src="/images/gst-delta-icon-teal-stroke-thick.svg" alt="" aria-hidden="true" class="option-icon" width="10" height="10" />{option.label}</span>
                                            {option.description && (
                                                <span class="option-description">{option.description}</span>
                                            )}
                                        </button>
                                    ))}
                                </div>
                            )}

                            {step.inputType === 'compound' && step.fields && (
                                <div class="compound-fields-grid">
                                    {step.fields.map((field) => (
                                        <div class="compound-field-section">
                                            <h3 class="field-section-label">{field.label}</h3>
                                            <div class="field-options-grid" data-field-id={field.id}>
                                                {field.options.map((opt) => (
                                                    <button
                                                        class="option-card compound-option"
                                                        data-option-id={opt.id}
                                                        data-field-id={field.id}
                                                        data-step-id={step.id}
                                                        type="button"
                                                        aria-pressed="false"
                                                    >
                                                        <span class="option-label">
                                                            <img
                                                                src="/images/gst-delta-icon-teal-stroke-thick.svg"
                                                                alt=""
                                                                aria-hidden="true"
                                                                class="option-icon"
                                                                width="10"
                                                                height="10"
                                                            />
                                                            {opt.label}
                                                        </span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>

                <!-- Navigation -->
                <div class="wizard-nav">
                    <button class="cta-button secondary" id="btnBack" type="button" disabled>Back</button>
                    <button class="cta-button primary" id="btnNext" type="button" disabled>Next</button>
                    <button class="cta-button primary" id="btnGenerate" type="button" style="display:none;">Generate Script</button>
                </div>
            </div>

            <!-- Output Container -->
            <div class="output-container" id="outputContainer" style="display:none;">

                <!-- Floating Action Bar -->
                <div class="doc-action-bar" id="docActionBar">
                    <button class="doc-action-btn" id="btnGoBack" type="button" aria-label="Go back to wizard">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                            <path d="M10 3L5 8l5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Back
                    </button>
                    <button class="doc-action-btn" id="btnCopy" type="button" aria-label="Copy to clipboard">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                            <rect x="5" y="5" width="9" height="9" rx="1.5" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M3 11V3a1.5 1.5 0 011.5-1.5H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span id="btnCopyLabel">Copy</span>
                    </button>
                    <button class="doc-action-btn" id="btnPrint" type="button" aria-label="Print document">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                            <path d="M4 6V1h8v5M4 12H2V7h12v5h-2" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                            <rect x="4" y="10" width="8" height="4" rx="0.5" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        Print
                    </button>
                    <button class="doc-action-btn" id="btnRestart" type="button" aria-label="Start over">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                            <path d="M2.5 2.5v4h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2.5 6.5A5.5 5.5 0 1 1 3 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Restart
                    </button>
                </div>

                <!-- The Document -->
                <div class="doc-page" id="docPage">

                    <!-- Document Header -->
                    <header class="doc-header">
                        <div class="doc-brand">
                            <img src="/images/gst-delta-icon-teal-stroke-thick.svg" alt="" aria-hidden="true" class="doc-brand-icon" width="24" height="24" />
                            <span class="doc-brand-name">Global Strategic Technologies</span>
                        </div>
                        <h1 class="doc-title">Overview and Agenda</h1>
                        <p class="doc-generation-date" id="docDate"></p>
                    </header>

                    <hr class="doc-divider doc-divider--heavy" />

                    <!-- Metadata Block -->
                    <section class="doc-meta" id="docMeta" aria-label="Input parameters"></section>

                    <hr class="doc-divider" />

                    <!-- Table of Contents & Risk Anchors Row -->
                    <div class="doc-toc-risk-row">
                        <!-- Table of Contents -->
                        <section class="doc-toc" id="docToc" aria-label="Table of contents"></section>

                        <!-- Risk Anchors -->
                        <section class="doc-risk-anchors" id="riskAnchorsSection" style="display:none;" aria-label="Risk anchors">
                            <h2 class="doc-section-heading">
                                <img src="/images/gst-delta-icon-teal-stroke-thick.svg" alt="" aria-hidden="true" width="14" height="14" />
                                Predictive Risk Anchors
                            </h2>
                            <div class="doc-risk-grid" id="riskAnchorsGrid"></div>
                        </section>
                    </div>

                    <!-- Topic Sections -->
                    <div class="doc-topics" id="scriptTopics"></div>

                    <!-- Document Footer -->
                    <footer class="doc-footer">
                        <hr class="doc-divider" />
                        <div class="doc-footer-content">
                            <div class="doc-footer-brand">
                                <img src="/images/gst-delta-icon-teal-stroke-thick.svg" alt="" aria-hidden="true" width="12" height="12" />
                                <span>https://globalstrategic.tech</span>
                            </div>
                        </div>
                        <p class="doc-footer-disclaimer">This script is a starting framework. Customize questions based on findings during the diligence process.</p>
                    </footer>
                </div>
            </div>

            <a href="/hub/tools" class="back-link" id="backToTools">
                <img src="/images/gst-delta-icon-teal-stroke-thick.svg" alt="" aria-hidden="true" width="10" height="10" />
                Back to The Workbench
            </a>
        </div>
    </section>
</BaseLayout>

<script>
    import { generateScript } from '../../../../utils/diligence-engine';
    import { getOptionLabel } from '../../../../data/diligence-machine/wizard-config';
    import type { UserInputs, GeneratedScript } from '../../../../utils/diligence-engine';

    const STORAGE_KEY = 'diligence-machine-state';
    const STORAGE_VERSION = 1;

    interface SavedState {
        version: number;
        currentStep: number;
        inputs: Partial<UserInputs>;
        targetIdentifier?: string;
    }

    // ─── STATE ────────────────────────────────────────────────────────────

    let currentStep = 1;
    const totalSteps = 5;
    let inputs: Partial<UserInputs> = {
        geographies: [],
    };
    let targetIdentifier = 'Target';
    let lastGeneratedScript: GeneratedScript | null = null;

    // ─── DOM REFERENCES ──────────────────────────────────────────────────

    const wizardContainer = document.getElementById('wizardContainer')!;
    const outputContainer = document.getElementById('outputContainer')!;
    const btnBack = document.getElementById('btnBack') as HTMLButtonElement;
    const btnNext = document.getElementById('btnNext') as HTMLButtonElement;
    const btnGenerate = document.getElementById('btnGenerate') as HTMLButtonElement;
    const btnGoBack = document.getElementById('btnGoBack') as HTMLButtonElement;
    const btnCopy = document.getElementById('btnCopy') as HTMLButtonElement;
    const btnPrint = document.getElementById('btnPrint') as HTMLButtonElement;
    const btnRestart = document.getElementById('btnRestart') as HTMLButtonElement;
    const riskAnchorsSection = document.getElementById('riskAnchorsSection')!;
    const riskAnchorsGrid = document.getElementById('riskAnchorsGrid')!;
    const scriptTopics = document.getElementById('scriptTopics')!;

    // ─── LOCAL STORAGE ───────────────────────────────────────────────────

    function saveState(): void {
        try {
            const state: SavedState = {
                version: STORAGE_VERSION,
                currentStep,
                inputs: { ...inputs },
                targetIdentifier,
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch {
            // localStorage may be unavailable in private browsing
        }
    }

    function loadState(): SavedState | null {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return null;
            const state = JSON.parse(raw) as SavedState;
            if (state.version !== STORAGE_VERSION) return null;
            return state;
        } catch {
            return null;
        }
    }

    function clearState(): void {
        try {
            localStorage.removeItem(STORAGE_KEY);
        } catch {
            // Ignore
        }
    }

    // ─── STEP NAVIGATION ─────────────────────────────────────────────────

    function showStep(step: number): void {
        currentStep = step;

        // Update step panels
        document.querySelectorAll('.wizard-step').forEach((el) => {
            const stepEl = el as HTMLElement;
            stepEl.classList.toggle('active', stepEl.dataset.step === String(step));
        });

        // Update progress indicators
        document.querySelectorAll('.progress-segment').forEach((el) => {
            const segEl = el as HTMLElement;
            const segStep = Number(segEl.dataset.stepIndicator);
            segEl.classList.toggle('active', segStep === step);
            segEl.classList.toggle('completed', segStep < step);
        });

        // Update progress bar aria
        const progressBar = document.querySelector('.wizard-progress') as HTMLElement;
        if (progressBar) progressBar.setAttribute('aria-valuenow', String(step));

        // Update navigation buttons
        btnBack.disabled = step === 1;
        btnBack.style.display = '';

        if (step === totalSteps) {
            btnNext.style.display = 'none';
            btnGenerate.style.display = '';
        } else {
            btnNext.style.display = '';
            btnGenerate.style.display = 'none';
        }

        updateNextButtonState();
        saveState();
    }

    function isStepValid(step: number): boolean {
        const stepEl = document.querySelector(`.wizard-step[data-step="${step}"]`) as HTMLElement;
        if (!stepEl) return false;
        const inputType = stepEl.dataset.inputType;
        const stepId = stepEl.dataset.stepId!;

        if (inputType === 'single-select') {
            const key = stepIdToInputKey(stepId);
            return key ? !!(inputs as Record<string, unknown>)[key] : false;
        }

        if (inputType === 'multi-select') {
            return (inputs.geographies?.length ?? 0) > 0;
        }

        if (inputType === 'compound') {
            return !!(inputs.headcount && inputs.revenueRange && inputs.growthStage && inputs.companyAge);
        }

        return false;
    }

    function updateNextButtonState(): void {
        const valid = isStepValid(currentStep);
        if (currentStep === totalSteps) {
            btnGenerate.disabled = !valid;
        } else {
            btnNext.disabled = !valid;
        }
    }

    function stepIdToInputKey(stepId: string): keyof UserInputs | null {
        const map: Record<string, keyof UserInputs> = {
            'transaction-type': 'transactionType',
            'product-type': 'productType',
            'tech-archetype': 'techArchetype',
        };
        return map[stepId] ?? null;
    }

    // ─── OPTION SELECTION ─────────────────────────────────────────────────

    function handleOptionClick(card: HTMLButtonElement): void {
        const optionId = card.dataset.optionId!;
        const stepId = card.dataset.stepId!;
        const stepEl = card.closest('.wizard-step') as HTMLElement;
        const inputType = stepEl.dataset.inputType;

        if (inputType === 'single-select') {
            // Deselect siblings
            stepEl.querySelectorAll('.option-card').forEach((el) => {
                el.classList.remove('selected');
                el.setAttribute('aria-pressed', 'false');
            });
            card.classList.add('selected');
            card.setAttribute('aria-pressed', 'true');

            const key = stepIdToInputKey(stepId);
            if (key) {
                (inputs as Record<string, unknown>)[key] = optionId;
            }
        } else if (inputType === 'multi-select') {
            const isSelected = card.classList.toggle('selected');
            card.setAttribute('aria-pressed', String(isSelected));

            if (!inputs.geographies) inputs.geographies = [];
            if (isSelected) {
                if (!inputs.geographies.includes(optionId)) {
                    inputs.geographies.push(optionId);
                }
            } else {
                inputs.geographies = inputs.geographies.filter((g) => g !== optionId);
            }
        }

        updateNextButtonState();
        saveState();
    }

    function handleCompoundOptionClick(card: HTMLButtonElement): void {
        const optionId = card.dataset.optionId!;
        const fieldId = card.dataset.fieldId!;
        const fieldGrid = card.closest('.field-options-grid') as HTMLElement;

        // Deselect all cards in this field's grid (single-select)
        fieldGrid.querySelectorAll('.option-card').forEach((el) => {
            el.classList.remove('selected');
            el.setAttribute('aria-pressed', 'false');
        });

        // Select clicked card
        card.classList.add('selected');
        card.setAttribute('aria-pressed', 'true');

        // Update state (same field mapping as handleFieldChange)
        const fieldMap: Record<string, keyof UserInputs> = {
            'headcount': 'headcount',
            'revenue-range': 'revenueRange',
            'growth-stage': 'growthStage',
            'company-age': 'companyAge',
        };

        const key = fieldMap[fieldId];
        if (key) {
            (inputs as Record<string, unknown>)[key] = optionId;
        }

        updateNextButtonState();
        saveState();
    }

    // ─── OUTPUT RENDERING ─────────────────────────────────────────────────

    function escapeHtml(text: string): string {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderOutput(script: GeneratedScript): void {
        lastGeneratedScript = script;

        // Hide wizard, show output
        wizardContainer.style.display = 'none';
        outputContainer.style.display = '';

        // Generation date
        const docDate = document.getElementById('docDate')!;
        const now = new Date();
        docDate.textContent = `Generated ${now.toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        })} at ${now.toLocaleTimeString('en-US', {
            hour: '2-digit', minute: '2-digit'
        })}`;

        // Metadata block
        renderMetaBlock();

        // Table of contents
        renderToc(script);

        // Render risk anchors
        if (script.riskAnchors.length > 0) {
            riskAnchorsSection.style.display = '';
            riskAnchorsGrid.innerHTML = script.riskAnchors
                .map((anchor) => `
                    <div class="doc-risk-card severity-${escapeHtml(anchor.severity)}">
                        <div class="doc-risk-header">
                            <span class="doc-risk-badge">${escapeHtml(anchor.severity)}</span>
                            <h3 class="doc-risk-title">${escapeHtml(anchor.title)}</h3>
                        </div>
                        <div class="doc-risk-divider"></div>
                        <p class="doc-risk-desc">${escapeHtml(anchor.description)}</p>
                    </div>
                `)
                .join('');
        } else {
            riskAnchorsSection.style.display = 'none';
        }

        // Render topics
        scriptTopics.innerHTML = script.topics
            .map((topic, topicIndex) => `
                <section class="doc-topic" id="topic-${topicIndex + 1}">
                    <div class="doc-topic-header">
                        <div class="doc-topic-label-row">
                            <span class="doc-topic-number">Topic ${topicIndex + 1} of ${script.topics.length}</span>
                            <span class="doc-topic-qcount">${topic.questions.length} question${topic.questions.length !== 1 ? 's' : ''}</span>
                        </div>
                        <h2 class="doc-topic-title">${escapeHtml(topic.topicLabel)}</h2>
                        <p class="doc-topic-audience">Target audience: ${escapeHtml(topic.audienceLevel)}</p>
                    </div>
                    <ol class="doc-questions">
                        ${topic.questions.map((q, qIndex) => `
                            <li class="doc-question priority-${escapeHtml(q.priority)}">
                                <div class="doc-q-header">
                                    <span class="doc-q-number">${topicIndex + 1}.${qIndex + 1}</span>
                                    <span class="doc-q-priority">${escapeHtml(q.priority)}</span>
                                </div>
                                <p class="doc-q-text">${escapeHtml(q.text)}</p>
                                <p class="doc-q-rationale">${escapeHtml(q.rationale)}</p>
                            </li>
                        `).join('')}
                    </ol>
                </section>
            `)
            .join('');

        // Scroll to top of output
        outputContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        saveState();
    }

    function renderMetaBlock(): void {
        const docMeta = document.getElementById('docMeta')!;
        const fields: { label: string; value: string }[] = [];

        if (inputs.transactionType) {
            fields.push({ label: 'Transaction Type', value: getOptionLabel('transaction-type', inputs.transactionType) });
        }
        if (inputs.productType) {
            fields.push({ label: 'Product Type', value: getOptionLabel('product-type', inputs.productType) });
        }
        if (inputs.techArchetype) {
            fields.push({ label: 'Tech Stack', value: getOptionLabel('tech-archetype', inputs.techArchetype) });
        }
        if (inputs.headcount) {
            fields.push({ label: 'Company Size', value: getOptionLabel('company-profile', inputs.headcount) + ' employees' });
        }
        if (inputs.revenueRange) {
            fields.push({ label: 'Revenue', value: getOptionLabel('company-profile', inputs.revenueRange) });
        }
        if (inputs.growthStage) {
            fields.push({ label: 'Growth Stage', value: getOptionLabel('company-profile', inputs.growthStage) });
        }
        if (inputs.companyAge) {
            fields.push({ label: 'Company Age', value: getOptionLabel('company-profile', inputs.companyAge) });
        }
        if (inputs.geographies && inputs.geographies.length > 0) {
            fields.push({
                label: 'Geography',
                value: inputs.geographies.map((g) => getOptionLabel('geography', g)).join(', '),
            });
        }

        docMeta.innerHTML = `
            <h2 class="doc-section-heading">
                <img src="/images/gst-delta-icon-teal-stroke-thick.svg" alt="" aria-hidden="true" width="14" height="14" />
                Target Parameters
            </h2>
            <div class="doc-meta-grid">
                <div class="doc-meta-card doc-meta-card--identifier">
                    <span class="doc-meta-label">Target / Project Identifier</span>
                    <input
                        type="text"
                        class="doc-meta-identifier-input"
                        id="targetIdentifierInput"
                        value="${escapeHtml(targetIdentifier)}"
                        maxlength="20"
                        aria-label="Target or project identifier"
                    />
                </div>
                ${fields.map((f) => `
                    <div class="doc-meta-card">
                        <span class="doc-meta-label">${escapeHtml(f.label)}</span>
                        <span class="doc-meta-value">${escapeHtml(f.value)}</span>
                    </div>
                `).join('')}
            </div>
        `;

        // Wire up identifier input
        const identifierInput = document.getElementById('targetIdentifierInput') as HTMLInputElement;
        identifierInput.addEventListener('input', () => {
            targetIdentifier = identifierInput.value || 'Target';
            saveState();
        });
    }

    function renderToc(script: GeneratedScript): void {
        const docToc = document.getElementById('docToc')!;
        docToc.innerHTML = `
            <h2 class="doc-section-heading">Contents</h2>
            <ol class="doc-toc-list">
                ${script.topics.map((topic, i) => `
                    <li>
                        <a href="#topic-${i + 1}" class="doc-toc-link">
                            <span class="doc-toc-topic-name">${escapeHtml(topic.topicLabel)}</span>
                        </a>
                    </li>
                `).join('')}
            </ol>
        `;

        // Wire up smooth-scroll click handlers
        docToc.querySelectorAll('.doc-toc-link').forEach((link) => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const href = (link as HTMLAnchorElement).getAttribute('href')!;
                document.querySelector(href)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });
    }

    // ─── COPY TO CLIPBOARD ───────────────────────────────────────────────

    function copyToClipboard(): void {
        if (!lastGeneratedScript) return;
        const script = lastGeneratedScript;

        const lines: string[] = [];
        lines.push('OVERVIEW AND AGENDA');
        lines.push('Global Strategic Technologies');
        lines.push(`Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`);
        lines.push('');
        lines.push('\u2550'.repeat(60));
        lines.push('TARGET PARAMETERS');
        lines.push('\u2550'.repeat(60));
        lines.push('');
        lines.push(`Identifier:        ${targetIdentifier}`);

        if (inputs.transactionType) lines.push(`Transaction Type:  ${getOptionLabel('transaction-type', inputs.transactionType)}`);
        if (inputs.productType) lines.push(`Product Type:      ${getOptionLabel('product-type', inputs.productType)}`);
        if (inputs.techArchetype) lines.push(`Tech Stack:        ${getOptionLabel('tech-archetype', inputs.techArchetype)}`);
        if (inputs.headcount) lines.push(`Company Size:      ${getOptionLabel('company-profile', inputs.headcount)} employees`);
        if (inputs.revenueRange) lines.push(`Revenue:           ${getOptionLabel('company-profile', inputs.revenueRange)}`);
        if (inputs.growthStage) lines.push(`Growth Stage:      ${getOptionLabel('company-profile', inputs.growthStage)}`);
        if (inputs.companyAge) lines.push(`Company Age:       ${getOptionLabel('company-profile', inputs.companyAge)}`);
        if (inputs.geographies && inputs.geographies.length > 0) {
            lines.push(`Geography:         ${inputs.geographies.map((g) => getOptionLabel('geography', g)).join(', ')}`);
        }
        lines.push('');

        // Risk anchors
        if (script.riskAnchors.length > 0) {
            lines.push('\u2550'.repeat(60));
            lines.push('PREDICTIVE RISK ANCHORS');
            lines.push('\u2550'.repeat(60));
            lines.push('');
            for (const anchor of script.riskAnchors) {
                lines.push(`[${anchor.severity.toUpperCase()}] ${anchor.title}`);
                lines.push(`  ${anchor.description}`);
                lines.push('');
            }
        }

        // Topics
        for (const [topicIndex, topic] of script.topics.entries()) {
            lines.push('\u2550'.repeat(60));
            lines.push(`TOPIC ${topicIndex + 1}: ${topic.topicLabel.toUpperCase()}`);
            lines.push(`Audience: ${topic.audienceLevel}`);
            lines.push('\u2550'.repeat(60));
            lines.push('');

            for (const [qIndex, q] of topic.questions.entries()) {
                lines.push(`${topicIndex + 1}.${qIndex + 1} [${q.priority.toUpperCase()}] ${q.text}`);
                lines.push(`    Rationale: ${q.rationale}`);
                lines.push('');
            }
        }

        lines.push('\u2500'.repeat(60));
        lines.push('Global Strategic Technologies | globalstrategic.tech');

        const text = lines.join('\n');

        navigator.clipboard.writeText(text).then(() => {
            const label = document.getElementById('btnCopyLabel')!;
            label.textContent = 'Copied!';
            setTimeout(() => { label.textContent = 'Copy'; }, 2000);
        }).catch(() => {
            const label = document.getElementById('btnCopyLabel')!;
            label.textContent = 'Failed';
            setTimeout(() => { label.textContent = 'Copy'; }, 2000);
        });
    }

    // ─── RESTART ──────────────────────────────────────────────────────────

    function restart(): void {
        inputs = { geographies: [] };
        targetIdentifier = 'Target';
        clearState();

        // Reset all option cards
        document.querySelectorAll('.option-card').forEach((el) => {
            el.classList.remove('selected');
            el.setAttribute('aria-pressed', 'false');
        });

        // Reset all selects
        document.querySelectorAll<HTMLSelectElement>('.field-select').forEach((el) => {
            el.value = '';
        });

        // Reset output
        outputContainer.style.display = 'none';
        wizardContainer.style.display = '';
        riskAnchorsGrid.innerHTML = '';
        scriptTopics.innerHTML = '';
        lastGeneratedScript = null;

        // Clear document sections
        const docMeta = document.getElementById('docMeta');
        if (docMeta) docMeta.innerHTML = '';
        const docToc = document.getElementById('docToc');
        if (docToc) docToc.innerHTML = '';

        showStep(1);
    }

    // ─── RESTORE STATE ───────────────────────────────────────────────────

    function restoreState(): void {
        const saved = loadState();
        if (!saved) return;

        inputs = { geographies: [], ...saved.inputs };
        if (saved.targetIdentifier) targetIdentifier = saved.targetIdentifier;

        // Restore single-select options
        for (const [stepId, key] of Object.entries({
            'transaction-type': 'transactionType',
            'product-type': 'productType',
            'tech-archetype': 'techArchetype',
        })) {
            const value = (inputs as Record<string, unknown>)[key] as string | undefined;
            if (value) {
                const card = document.querySelector(
                    `.option-card[data-step-id="${stepId}"][data-option-id="${value}"]`
                );
                if (card) {
                    card.classList.add('selected');
                    card.setAttribute('aria-pressed', 'true');
                }
            }
        }

        // Restore multi-select (geography)
        if (inputs.geographies && inputs.geographies.length > 0) {
            for (const geo of inputs.geographies) {
                const card = document.querySelector(
                    `.option-card[data-step-id="geography"][data-option-id="${geo}"]`
                );
                if (card) {
                    card.classList.add('selected');
                    card.setAttribute('aria-pressed', 'true');
                }
            }
        }

        // Restore compound field option cards
        const compoundFieldMap: Record<string, string> = {
            'headcount': 'headcount',
            'revenue-range': 'revenueRange',
            'growth-stage': 'growthStage',
            'company-age': 'companyAge',
        };
        for (const [fieldId, key] of Object.entries(compoundFieldMap)) {
            const value = (inputs as Record<string, unknown>)[key] as string | undefined;
            if (value) {
                const card = document.querySelector(
                    `.option-card.compound-option[data-field-id="${fieldId}"][data-option-id="${value}"]`
                );
                if (card) {
                    card.classList.add('selected');
                    card.setAttribute('aria-pressed', 'true');
                }
            }
        }

        showStep(saved.currentStep);
    }

    // ─── EVENT BINDING ────────────────────────────────────────────────────

    // Option card clicks
    document.querySelectorAll('.option-card').forEach((card) => {
        card.addEventListener('click', () => handleOptionClick(card as HTMLButtonElement));
    });

    // Compound field option cards
    document.querySelectorAll('.option-card.compound-option').forEach((card) => {
        card.addEventListener('click', () => handleCompoundOptionClick(card as HTMLButtonElement));
    });

    // Navigation
    btnBack.addEventListener('click', () => {
        if (currentStep > 1) showStep(currentStep - 1);
    });

    btnNext.addEventListener('click', () => {
        if (currentStep < totalSteps && isStepValid(currentStep)) {
            showStep(currentStep + 1);
        }
    });

    btnGenerate.addEventListener('click', () => {
        if (!isStepValid(currentStep)) return;

        const fullInputs: UserInputs = {
            transactionType: inputs.transactionType!,
            productType: inputs.productType!,
            techArchetype: inputs.techArchetype!,
            headcount: inputs.headcount!,
            revenueRange: inputs.revenueRange!,
            growthStage: inputs.growthStage!,
            companyAge: inputs.companyAge!,
            geographies: inputs.geographies ?? [],
        };

        const script = generateScript(fullInputs);
        renderOutput(script);
    });

    btnGoBack.addEventListener('click', () => {
        outputContainer.style.display = 'none';
        wizardContainer.style.display = '';
        showStep(totalSteps);
    });
    btnCopy.addEventListener('click', copyToClipboard);
    btnPrint.addEventListener('click', () => window.print());
    btnRestart.addEventListener('click', restart);

    // ─── INITIALIZE ───────────────────────────────────────────────────────

    restoreState();
</script>

<style>
    /* ─── LAYOUT ───────────────────────────────────────────────────────── */

    .diligence-machine {
        padding: var(--spacing-3xl) 0;
        min-height: 80vh;
    }

    .dm-header {
        text-align: center;
        margin-bottom: var(--spacing-3xl);
    }

    .section-label {
        font-size: var(--text-xs);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-primary);
        margin-bottom: var(--spacing-xs);
        display: block;
    }

    .dm-header h1 {
        font-size: var(--text-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--text-light-primary);
        text-transform: uppercase;
        letter-spacing: 0.02em;
        margin: 0 0 var(--spacing-sm) 0;
    }

    .dm-subtitle {
        font-size: var(--text-lg);
        color: var(--text-light-secondary);
        line-height: 1.7;
        max-width: 600px;
        margin: 0 auto;
    }

    /* ─── PROGRESS BAR ─────────────────────────────────────────────────── */

    .wizard-progress {
        display: flex;
        justify-content: center;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-3xl);
        flex-wrap: wrap;
    }

    .progress-segment {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-xs);
        flex: 1;
        max-width: 160px;
        min-width: 60px;
        opacity: 0.4;
        transition: opacity var(--transition-normal);
    }

    .progress-segment.active,
    .progress-segment.completed {
        opacity: 1;
    }

    .progress-number {
        width: 3rem;
        height: 3rem;
        flex-shrink: 0;
        color: var(--border-light);
        transition: color var(--transition-normal);
    }

    .progress-segment.active .progress-number {
        color: var(--color-primary);
    }

    .progress-segment.completed .progress-number path {
        fill: var(--color-primary);
        stroke: var(--color-primary);
    }

    .progress-number-text {
        font-size: 1.1rem;
        font-weight: var(--font-weight-bold);
        fill: var(--text-light-muted);
        transition: fill var(--transition-normal);
    }

    .progress-segment.active .progress-number-text {
        fill: var(--text-light-primary);
    }

    .progress-segment.completed .progress-number-text {
        fill: var(--bg-light);
    }

    .progress-label {
        font-size: var(--text-xs);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-light-muted);
        text-align: center;
    }

    .progress-segment.active .progress-label {
        color: var(--text-light-primary);
    }

    :global(html.dark-theme) .progress-number-text {
        fill: var(--text-dark-muted);
    }

    :global(html.dark-theme) .progress-segment.active .progress-number-text {
        fill: var(--text-dark-primary);
    }

    :global(html.dark-theme) .progress-segment.completed .progress-number-text {
        fill: var(--bg-dark);
    }

    /* ─── WIZARD STEPS ─────────────────────────────────────────────────── */

    .wizard-step {
        display: none;
        max-width: 390px;
        margin: 0 auto;
    }

    .wizard-step.active {
        display: block;
    }

    .step-title {
        font-size: var(--text-xl);
        font-weight: var(--font-weight-bold);
        color: var(--text-light-primary);
        text-align: center;
        margin: 0 0 var(--spacing-sm) 0;
    }

    .step-subtitle {
        font-size: var(--text-base);
        color: var(--text-light-secondary);
        text-align: center;
        margin: 0 0 var(--spacing-2xl) 0;
        line-height: 1.6;
    }

    /* ─── OPTION CARDS ─────────────────────────────────────────────────── */

    .options-grid {
        display: grid;
        gap: var(--spacing-md);
    }

    /* Geography step: two-column layout for efficient whitespace usage */
    [data-step-id="geography"] .options-grid {
        grid-template-columns: 1fr; /* Mobile: single column */
        max-width: 100%;
        margin: 0 auto;
    }

    @media (min-width: 480px) {
        [data-step-id="geography"] .options-grid {
            grid-template-columns: repeat(2, 1fr); /* Two columns on tablets and up */
            max-width: 560px; /* ~80% of 700px step width */
            column-gap: var(--spacing-lg);
        }
    }

    @media (min-width: 768px) {
        [data-step-id="geography"] .options-grid {
            max-width: 580px; /* ~83% of 700px step width */
        }
    }

    @media (min-width: 1024px) {
        [data-step-id="geography"] .options-grid {
            max-width: 640px; /* ~80% of 800px desktop width */
        }
    }

    .option-card {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-light);
        border: 2px solid var(--border-light);
        border-radius: 8px;
        cursor: pointer;
        transition: all var(--transition-normal);
        text-align: left;
        font-family: var(--font-family);
        color: var(--text-light-primary);
        box-shadow: var(--shadow-sm);
    }

    .option-card:hover {
        border-color: var(--color-primary);
        background: rgba(5, 205, 153, 0.06);
        box-shadow: 0 2px 12px rgba(5, 205, 153, 0.15);
        transform: translateY(-1px);
    }

    .option-card:focus-visible {
        outline: 2px solid var(--color-primary);
        outline-offset: 2px;
    }

    .option-card.selected {
        border-color: var(--color-primary);
        background: rgba(5, 205, 153, 0.1);
        box-shadow: 0 0 0 1px var(--color-primary), 0 2px 12px rgba(5, 205, 153, 0.2);
    }

    :global(html.dark-theme) .option-card {
        background: var(--bg-dark-secondary);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    :global(html.dark-theme) .option-card:hover {
        background: rgba(5, 205, 153, 0.1);
        box-shadow: 0 2px 12px rgba(5, 205, 153, 0.2);
    }

    :global(html.dark-theme) .option-card.selected {
        background: rgba(5, 205, 153, 0.15);
    }

    .option-label {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--text-base);
        font-weight: var(--font-weight-semibold);
        color: var(--text-light-primary);
    }

    .option-icon {
        flex-shrink: 0;
        opacity: 0.7;
    }

    .option-card.selected .option-icon {
        opacity: 1;
    }

    .option-description {
        font-size: var(--text-sm);
        color: var(--text-light-muted);
        line-height: 1.5;
        margin-left: calc(10px + var(--spacing-sm));
    }

    /* ─── COMPOUND FIELD SECTIONS ────────────────────────────────────────── */

    .compound-fields-grid {
        display: grid;
        gap: var(--spacing-3xl);
    }

    .compound-field-section {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .field-section-label {
        font-size: var(--text-sm);
        font-weight: var(--font-weight-semibold);
        color: var(--text-light-primary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0;
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid rgba(5, 205, 153, 0.2);
    }

    .field-options-grid {
        display: grid;
        gap: var(--spacing-md);
        grid-template-columns: 1fr; /* Mobile-first: 1 column */
    }

    .option-card.compound-option {
        min-height: 52px; /* Ensure WCAG touch target */
        justify-content: center;
    }

    :global(html.dark-theme) .field-section-label {
        color: var(--text-dark-primary);
        border-bottom-color: rgba(5, 205, 153, 0.3);
    }

    /* ─── NAVIGATION ───────────────────────────────────────────────────── */

    .wizard-nav {
        display: flex;
        justify-content: center;
        gap: var(--spacing-lg);
        margin-top: var(--spacing-3xl);
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
    }

    .wizard-nav .cta-button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    /* ─── DOCUMENT ACTION BAR ──────────────────────────────────────────── */

    .doc-action-bar {
        position: sticky;
        top: 0;
        z-index: 5;
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) 0;
        margin-bottom: var(--spacing-lg);
    }

    .doc-action-btn {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm) var(--spacing-lg);
        font-size: var(--text-xs);
        font-weight: var(--font-weight-semibold);
        font-family: var(--font-family);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-light-secondary);
        background: var(--bg-light);
        border: 1px solid var(--border-light);
        border-radius: 4px;
        cursor: pointer;
        transition: all var(--transition-fast);
        box-shadow: var(--shadow-sm);
    }

    #btnGoBack {
        margin-right: auto;
    }

    .doc-action-btn:hover {
        color: var(--color-primary);
        border-color: var(--color-primary);
    }

    :global(html.dark-theme) .doc-action-btn {
        background: var(--bg-dark-secondary);
        border-color: var(--border-dark);
        color: var(--text-dark-secondary);
    }

    :global(html.dark-theme) .doc-action-btn:hover {
        color: var(--color-primary);
        border-color: var(--color-primary);
    }

    /* ─── DOCUMENT PAGE ────────────────────────────────────────────────── */

    .output-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .doc-page {
        background: var(--bg-light);
        border: 1px solid var(--border-light);
        border-radius: 2px;
        box-shadow: var(--shadow-md);
        padding: var(--spacing-3xl);
    }

    .doc-page,
    .doc-page * {
        user-select: text;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
    }

    :global(html.dark-theme) .doc-page {
        background: var(--bg-dark-secondary);
        border-color: var(--border-dark);
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
    }

    /* ─── DOCUMENT HEADER ──────────────────────────────────────────────── */

    .doc-header {
        text-align: center;
        margin-bottom: var(--spacing-lg);
    }

    .doc-brand {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
    }

    .doc-brand-icon {
        flex-shrink: 0;
    }

    .doc-brand-name {
        font-size: var(--text-xs);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--text-light-muted);
    }

    .doc-title {
        font-size: var(--text-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--text-light-primary);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin: 0 0 var(--spacing-xs) 0;
    }

    .doc-generation-date {
        font-size: var(--text-xs);
        color: var(--text-light-muted);
        margin: 0;
        margin-top: var(--spacing-xs);
    }

    /* ─── DIVIDERS ─────────────────────────────────────────────────────── */

    .doc-divider {
        border: none;
        border-top: 1px solid var(--border-light);
        margin: var(--spacing-xl) 0;
    }

    .doc-divider--heavy {
        border-top-width: 3px;
        border-top-color: var(--color-primary);
    }

    :global(html.dark-theme) .doc-divider {
        border-top-color: var(--border-dark);
    }

    :global(html.dark-theme) .doc-divider--heavy {
        border-top-color: var(--color-primary);
    }

    :global(html.dark-theme) .doc-meta-label {
        color: var(--color-primary);
        opacity: 0.6;
    }

    :global(html.dark-theme) .doc-meta-value {
        color: var(--text-dark-primary);
    }

    /* ─── SECTION HEADINGS ─────────────────────────────────────────────── */

    .doc-page :global(.doc-section-heading) {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-primary);
        margin: 0 0 var(--spacing-lg) 0;
    }

    /* ─── METADATA BLOCK ───────────────────────────────────────────────── */

    .doc-meta :global(.doc-meta-grid) {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-sm);
        margin: 0;
        padding-left: var(--spacing-xl);
    }

    .doc-meta :global(.doc-meta-card) {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: var(--spacing-sm) 0;
    }

    .doc-meta :global(.doc-meta-label) {
        font-size: 0.65rem;
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-primary);
        opacity: 0.7;
    }

    .doc-meta :global(.doc-meta-value) {
        font-size: var(--text-sm);
        font-weight: var(--font-weight-semibold);
        color: var(--text-light-primary);
        line-height: 1.3;
    }

    .doc-meta :global(.doc-meta-card--identifier) {
        grid-column: span 1;
    }

    .doc-meta :global(.doc-meta-identifier-input) {
        font-family: inherit;
        font-size: var(--text-sm);
        font-weight: var(--font-weight-semibold);
        color: var(--text-light-primary);
        line-height: 1.3;
        background: transparent;
        border: 1px solid transparent;
        border-bottom: 1px dashed rgba(5, 205, 153, 0.3);
        padding: 2px 0;
        width: 75%;
        outline: none;
        transition: border-color var(--transition-fast);
    }

    .doc-meta :global(.doc-meta-identifier-input:focus) {
        border-bottom-color: var(--color-primary);
    }

    .doc-meta :global(.doc-meta-identifier-input::placeholder) {
        color: var(--text-light-muted);
        font-weight: var(--font-weight-normal);
    }

    :global(html.dark-theme) .doc-meta :global(.doc-meta-identifier-input) {
        color: var(--text-dark-primary);
        border-bottom-color: rgba(5, 205, 153, 0.2);
    }

    :global(html.dark-theme) .doc-meta :global(.doc-meta-identifier-input:focus) {
        border-bottom-color: var(--color-primary);
    }

    /* ─── TOC & RISK ANCHORS ROW ────────────────────────────────────────── */

    .doc-toc-risk-row {
        display: grid;
        grid-template-columns: 1fr 3fr;
        gap: var(--spacing-2xl);
        margin-bottom: var(--spacing-lg);
        align-items: start;
    }

    /* ─── TABLE OF CONTENTS ────────────────────────────────────────────── */

    .doc-toc :global(.doc-section-heading) {
        justify-content: center;
    }

    .doc-toc :global(.doc-toc-list) {
        list-style: none;
        padding: 0;
        margin: 0;
        max-width: 100%;
    }

    .doc-toc :global(.doc-toc-list li + li::before) {
        content: '';
        display: block;
        width: 2rem;
        height: 2px;
        background: var(--color-primary);
        opacity: 0.4;
        margin: var(--spacing-sm) auto;
    }

    .doc-toc :global(.doc-toc-link) {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: var(--spacing-sm) 0;
        text-decoration: none;
        color: var(--text-light-primary);
        transition: color var(--transition-fast);
    }

    .doc-toc :global(.doc-toc-link:hover) {
        color: var(--color-primary);
    }

    :global(html.dark-theme) .doc-toc :global(.doc-toc-link) {
        color: var(--text-dark-primary);
    }

    :global(html.dark-theme) .doc-toc :global(.doc-toc-link:hover) {
        color: var(--color-primary);
    }

    .doc-toc :global(.doc-toc-topic-name) {
        font-size: var(--text-sm);
        font-weight: var(--font-weight-semibold);
    }

    /* ─── RISK ANCHORS ─────────────────────────────────────────────────── */

    .doc-risk-anchors {
        margin-bottom: 0;
    }

    .doc-risk-grid {
        display: grid;
        gap: var(--spacing-md);
        padding-left: 0;
    }

    .doc-risk-grid :global(.doc-risk-card) {
        padding: var(--spacing-xl);
        border-left: 3px solid var(--color-primary);
        background: rgba(5, 205, 153, 0.03);
        border-radius: 4px;
    }

    .doc-risk-grid :global(.doc-risk-card.severity-high) {
        border-left-color: #e74c3c;
        background: rgba(231, 76, 60, 0.04);
    }

    .doc-risk-grid :global(.doc-risk-card.severity-medium) {
        border-left-color: #f39c12;
        background: rgba(243, 156, 18, 0.04);
    }

    :global(html.dark-theme) .doc-risk-grid :global(.doc-risk-card) {
        background: rgba(5, 205, 153, 0.06);
    }

    :global(html.dark-theme) .doc-risk-grid :global(.doc-risk-card.severity-high) {
        background: rgba(231, 76, 60, 0.08);
    }

    :global(html.dark-theme) .doc-risk-grid :global(.doc-risk-card.severity-medium) {
        background: rgba(243, 156, 18, 0.06);
    }

    .doc-risk-grid :global(.doc-risk-header) {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .doc-risk-grid :global(.doc-risk-badge) {
        display: inline-block;
        font-size: 0.7rem;
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 2px var(--spacing-sm);
        border-radius: 2px;
        flex-shrink: 0;
    }

    .doc-risk-grid :global(.severity-high .doc-risk-badge) {
        background: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
        border: 1px solid rgba(231, 76, 60, 0.3);
    }

    .doc-risk-grid :global(.severity-medium .doc-risk-badge) {
        background: rgba(243, 156, 18, 0.15);
        color: #f39c12;
        border: 1px solid rgba(243, 156, 18, 0.3);
    }

    .doc-risk-grid :global(.severity-low .doc-risk-badge) {
        background: rgba(5, 205, 153, 0.15);
        color: var(--color-primary);
        border: 1px solid rgba(5, 205, 153, 0.3);
    }

    .doc-risk-grid :global(.doc-risk-title) {
        font-size: var(--text-base);
        font-weight: var(--font-weight-bold);
        color: var(--text-light-primary);
        line-height: 1.4;
        margin: 0;
    }

    :global(html.dark-theme) .doc-risk-grid :global(.doc-risk-title) {
        color: var(--text-dark-primary);
    }

    .doc-risk-grid :global(.doc-risk-divider) {
        width: 2rem;
        height: 2px;
        border: none;
        opacity: 0.4;
        margin: var(--spacing-md) 0;
    }

    .doc-risk-grid :global(.doc-risk-card .doc-risk-divider) {
        background: var(--color-primary);
    }

    .doc-risk-grid :global(.severity-high .doc-risk-divider) {
        background: #e74c3c;
    }

    .doc-risk-grid :global(.severity-medium .doc-risk-divider) {
        background: #f39c12;
    }

    .doc-risk-grid :global(.doc-risk-desc) {
        font-size: var(--text-sm);
        color: var(--text-light-secondary);
        line-height: 1.7;
        margin: 0;
    }

    /* ─── TOPIC SECTIONS ───────────────────────────────────────────────── */
    /* All topic/question elements are dynamically injected via innerHTML,
       so they need :global() wrappers anchored on the static .doc-topics parent */

    .doc-topics :global(.doc-topic) {
        margin-top: var(--spacing-3xl);
    }

    .doc-topics :global(.doc-topic-header) {
        padding-bottom: var(--spacing-lg);
        border-bottom: 2px solid var(--color-primary);
        margin-bottom: var(--spacing-xl);
    }

    .doc-topics :global(.doc-topic-label-row) {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xs);
    }

    .doc-topics :global(.doc-topic-number) {
        font-size: var(--text-xs);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--color-primary);
    }

    .doc-topics :global(.doc-topic-qcount) {
        font-size: var(--text-xs);
        color: var(--text-light-muted);
        font-weight: var(--font-weight-semibold);
    }

    .doc-topics :global(.doc-topic-title) {
        font-size: var(--text-xl);
        font-weight: var(--font-weight-bold);
        color: var(--text-light-primary);
        margin: 0 0 var(--spacing-xs) 0;
    }

    .doc-topics :global(.doc-topic-audience) {
        font-size: var(--text-sm);
        color: var(--text-light-muted);
        font-style: italic;
        margin: 0;
    }

    /* ─── QUESTIONS ────────────────────────────────────────────────────── */

    .doc-topics :global(.doc-questions) {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: var(--spacing-xl);
    }

    .doc-topics :global(.doc-question) {
        padding: var(--spacing-lg);
        border: 1px solid var(--border-light);
        border-radius: 2px;
        border-left: 3px solid var(--border-light);
    }

    .doc-topics :global(.doc-question.priority-critical) {
        border-left-color: #e74c3c;
    }

    .doc-topics :global(.doc-question.priority-high) {
        border-left-color: #f39c12;
    }

    .doc-topics :global(.doc-question.priority-standard) {
        border-left-color: var(--color-primary);
    }

    :global(html.dark-theme) .doc-topics :global(.doc-question) {
        border-color: var(--border-dark);
    }

    :global(html.dark-theme) .doc-topics :global(.doc-question.priority-critical) {
        border-left-color: #e74c3c;
    }

    :global(html.dark-theme) .doc-topics :global(.doc-question.priority-high) {
        border-left-color: #f39c12;
    }

    :global(html.dark-theme) .doc-topics :global(.doc-question.priority-standard) {
        border-left-color: var(--color-primary);
    }

    .doc-topics :global(.doc-q-header) {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
    }

    .doc-topics :global(.doc-q-number) {
        font-size: var(--text-sm);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary);
    }

    .doc-topics :global(.doc-q-priority) {
        font-size: var(--text-xs);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 1px var(--spacing-sm);
        border-radius: 2px;
    }

    .doc-topics :global(.priority-critical .doc-q-priority) {
        background: rgba(231, 76, 60, 0.12);
        color: #e74c3c;
    }

    .doc-topics :global(.priority-high .doc-q-priority) {
        background: rgba(243, 156, 18, 0.12);
        color: #f39c12;
    }

    .doc-topics :global(.priority-standard .doc-q-priority) {
        background: rgba(5, 205, 153, 0.12);
        color: var(--color-primary);
    }

    .doc-topics :global(.doc-q-text) {
        font-size: var(--text-base);
        font-weight: var(--font-weight-semibold);
        color: var(--text-light-primary);
        line-height: 1.7;
        margin: 0 0 var(--spacing-sm) 0;
    }

    .doc-topics :global(.doc-q-rationale) {
        font-size: var(--text-sm);
        color: var(--text-light-muted);
        line-height: 1.6;
        font-style: italic;
        margin: 0;
    }

    /* ─── DOCUMENT FOOTER ──────────────────────────────────────────────── */

    .doc-footer {
        margin-top: var(--spacing-md);
        opacity: 0.5;
    }

    .doc-footer .doc-divider {
        margin: 0 0 var(--spacing-xs) 0;
    }

    .doc-footer-content {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: 4px;
    }

    .doc-footer-brand {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.6rem;
        font-weight: var(--font-weight-semibold);
        letter-spacing: 0.02em;
        color: var(--text-light-secondary);
    }

    .doc-footer-brand img {
        width: 10px;
        height: 10px;
    }

    .doc-footer-disclaimer {
        font-size: 0.6rem;
        color: var(--text-light-muted);
        line-height: 1.4;
        margin: 0;
    }

    :global(html.dark-theme) .doc-footer-brand {
        color: var(--text-dark-secondary);
    }

    :global(html.dark-theme) .doc-footer-disclaimer {
        color: var(--text-dark-muted);
    }

    /* ─── BACK LINK ────────────────────────────────────────────────────── */

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-3xl);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-semibold);
        color: var(--text-light-muted);
        text-decoration: none;
        transition: color var(--transition-fast);
    }

    .back-link:hover {
        color: var(--color-primary);
    }

    /* ─── RESPONSIVE ───────────────────────────────────────────────────── */

    @media (min-width: 768px) {
        .diligence-machine {
            padding: 2.5rem 0;
        }

        .dm-header h1 {
            font-size: 2.5rem;
        }

        /* Expand wizard step width on tablet+ for better multi-column layout */
        .wizard-step {
            max-width: 700px;
        }

        /* Headcount (4 options): 2 columns in 2x2 grid */
        .field-options-grid[data-field-id="headcount"] {
            grid-template-columns: repeat(2, 1fr);
        }

        /* Revenue Range (4 options): 2 columns in 2x2 grid */
        .field-options-grid[data-field-id="revenue-range"] {
            grid-template-columns: repeat(2, 1fr);
        }

        /* Growth Stage (3 options): 3 columns in single row */
        .field-options-grid[data-field-id="growth-stage"] {
            grid-template-columns: repeat(3, 1fr);
        }

        /* Company Age (5 options): 3 columns (2-2-1 layout) */
        .field-options-grid[data-field-id="company-age"] {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (min-width: 1024px) {
        /* Desktop: even wider for optimal spacing */
        .wizard-step {
            max-width: 800px;
        }

        /* Headcount (4 options): 4 columns in single row */
        .field-options-grid[data-field-id="headcount"] {
            grid-template-columns: repeat(4, 1fr);
        }

        /* Revenue Range (4 options): 4 columns in single row */
        .field-options-grid[data-field-id="revenue-range"] {
            grid-template-columns: repeat(4, 1fr);
        }

        /* Company Age (5 options): 5 columns in single row */
        .field-options-grid[data-field-id="company-age"] {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    @media (max-width: 480px) {
        .diligence-machine {
            padding: var(--spacing-2xl) 0;
        }

        .dm-header h1 {
            font-size: var(--text-xl);
        }

        .wizard-progress {
            gap: var(--spacing-xs);
        }

        .progress-label {
            display: none;
        }

        .option-card {
            padding: var(--spacing-lg);
        }

        .compound-fields-grid {
            gap: var(--spacing-2xl);
        }

        .field-section-label {
            font-size: 0.8rem;
        }

        .wizard-nav {
            flex-direction: column;
        }

        /* Document output mobile overrides */
        .doc-page {
            padding: var(--spacing-xl) var(--spacing-lg);
        }

        .doc-title {
            font-size: var(--text-xl);
        }

        .doc-meta :global(.doc-meta-grid) {
            grid-template-columns: 1fr;
            padding-left: var(--spacing-md);
        }

        .doc-toc-risk-row {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }

        .doc-toc :global(.doc-toc-list) {
            padding-left: var(--spacing-md);
            max-width: 100%;
        }

        .doc-risk-grid {
            padding-left: var(--spacing-md);
        }

        .doc-action-bar {
            flex-wrap: wrap;
        }

        .doc-action-btn {
            flex: 1 1 auto;
        }

        .doc-topics :global(.doc-topic-label-row) {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-xs);
        }

        .doc-topics :global(.doc-q-header) {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-xs);
        }

        .doc-footer-content {
            flex-wrap: wrap;
            justify-content: center;
        }
    }

    /* ─── PRINT ────────────────────────────────────────────────────────── */

    @media print {
        /* Page setup */
        html, body {
            height: auto;
        }

        .dm-header,
        .wizard-container,
        .wizard-nav,
        .doc-action-bar,
        .back-link {
            display: none !important;
        }

        .diligence-machine {
            padding: 0;
        }

        .output-container {
            display: block !important;
            max-width: 100%;
        }

        .doc-page {
            border: none;
            box-shadow: none;
            padding: 40px;
            background: white;
            page-break-after: avoid;
        }

        /* Document header - keep tight */
        .doc-header {
            color: var(--color-primary);
            margin-bottom: 12px;
            page-break-after: avoid;
        }

        .doc-title {
            margin: 0 0 4px 0;
            font-size: 20px;
            page-break-after: avoid;
        }

        .doc-generation-date {
            margin: 0;
            font-size: 11px;
        }

        /* Dividers - reduce spacing */
        .doc-divider {
            margin: 16px 0;
            border-top-color: var(--color-primary);
        }

        .doc-divider--heavy {
            margin: 12px 0;
            border-top-color: var(--color-primary);
            page-break-after: avoid;
        }

        /* Metadata grid - compact */
        .doc-meta :global(.doc-meta-grid) {
            gap: 8px;
            margin: 0;
            padding-left: 0;
            page-break-after: avoid;
        }

        .doc-meta :global(.doc-meta-card) {
            gap: 2px;
            padding: 6px 0;
            page-break-inside: avoid;
        }

        .doc-meta :global(.doc-meta-label) {
            font-size: 0.65rem;
            opacity: 0.7;
        }

        .doc-meta :global(.doc-meta-value) {
            font-size: 13px;
            line-height: 1.2;
        }

        .doc-meta :global(.doc-meta-identifier-input) {
            border: none !important;
            padding: 0 !important;
            font-size: 13px;
        }

        /* TOC and Risk Anchors - force page break after */
        .doc-toc-risk-row {
            page-break-after: always;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .doc-toc :global(.doc-section-heading),
        .doc-risk-anchors :global(.doc-section-heading) {
            font-size: 12px;
            margin: 0 0 8px 0;
            page-break-after: avoid;
        }

        .doc-toc :global(.doc-toc-list) {
            list-style: none;
            padding: 0;
            margin: 0;
            page-break-inside: avoid;
        }

        .doc-toc :global(.doc-toc-list li) {
            margin: 2px 0;
            page-break-inside: avoid;
        }

        .doc-toc :global(.doc-toc-list li + li::before) {
            display: none;
        }

        .doc-toc :global(.doc-toc-link) {
            padding: 3px 0;
            font-size: 12px;
            line-height: 1.3;
        }

        .doc-toc :global(.doc-toc-topic-name) {
            font-size: 12px;
            font-weight: var(--font-weight-semibold);
        }

        /* Risk anchors - compact cards */
        .doc-risk-grid {
            gap: 8px;
            padding-left: 0;
            page-break-inside: avoid;
        }

        .doc-risk-grid :global(.doc-risk-card) {
            padding: 12px;
            border-left: 2px solid var(--color-primary);
            break-inside: avoid;
        }

        .doc-risk-grid :global(.doc-risk-card.severity-high) {
            border-left-color: #e74c3c;
        }

        .doc-risk-grid :global(.doc-risk-card.severity-medium) {
            border-left-color: #f39c12;
        }

        .doc-risk-grid :global(.doc-risk-header) {
            display: block;
            page-break-inside: avoid;
        }

        .doc-risk-grid :global(.doc-risk-badge) {
            font-size: 0.6rem;
            padding: 1px 6px;
            margin-bottom: 4px;
            display: inline-block;
        }

        .doc-risk-grid :global(.doc-risk-title) {
            font-size: 13px;
            font-weight: var(--font-weight-bold);
            margin: 0 0 2px 0;
            color: var(--color-primary);
        }

        .doc-risk-grid :global(.doc-risk-divider) {
            display: none;
        }

        .doc-risk-grid :global(.doc-risk-desc) {
            font-size: 11px;
            line-height: 1.4;
            margin: 0;
        }

        /* Topics - one per page, ultra-condensed */
        .doc-topics :global(.doc-topic) {
            page-break-before: always;
            margin-top: 0;
            margin-bottom: 0;
            break-inside: avoid;
        }

        .doc-topics :global(.doc-topic-header) {
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-primary);
            margin-bottom: 8px;
            page-break-after: avoid;
        }

        .doc-topics :global(.doc-topic-label-row) {
            margin-bottom: 2px;
            gap: 12px;
            page-break-after: avoid;
        }

        .doc-topics :global(.doc-topic-number) {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .doc-topics :global(.doc-topic-qcount) {
            font-size: 10px;
        }

        .doc-topics :global(.doc-topic-title) {
            font-size: 16px;
            font-weight: var(--font-weight-bold);
            margin: 0 0 2px 0;
            color: var(--color-primary);
            page-break-after: avoid;
        }

        .doc-topics :global(.doc-topic-audience) {
            font-size: 10px;
            margin: 0;
            font-style: italic;
            page-break-after: avoid;
        }

        /* Questions - ultra-tight spacing */
        .doc-topics :global(.doc-questions) {
            gap: 6px;
            margin: 0;
            padding: 0;
            page-break-inside: avoid;
        }

        .doc-topics :global(.doc-question) {
            padding: 8px;
            border: 0.5px solid #ccc;
            border-left: 2px solid var(--color-primary);
            margin: 0;
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .doc-topics :global(.doc-question.priority-critical) {
            border-left-color: #e74c3c;
        }

        .doc-topics :global(.doc-question.priority-high) {
            border-left-color: #f39c12;
        }

        .doc-topics :global(.doc-q-header) {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 3px;
            gap: 8px;
            page-break-after: avoid;
        }

        .doc-topics :global(.doc-q-number) {
            font-size: 11px;
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            flex-shrink: 0;
            page-break-after: avoid;
        }

        .doc-topics :global(.doc-q-priority) {
            font-size: 8px;
            font-weight: var(--font-weight-bold);
            text-transform: uppercase;
            padding: 1px 4px;
            border-radius: 1px;
            flex-shrink: 0;
            page-break-after: avoid;
        }

        .doc-topics :global(.doc-q-text) {
            font-size: 12px;
            font-weight: var(--font-weight-semibold);
            line-height: 1.3;
            margin: 0 0 2px 0;
            color: var(--color-primary);
            page-break-after: avoid;
        }

        .doc-topics :global(.doc-q-rationale) {
            font-size: 10px;
            line-height: 1.3;
            margin: 0;
            font-style: italic;
            color: #333;
            page-break-after: avoid;
        }

        /* Footer - minimal */
        .doc-footer {
            margin-top: 16px;
            opacity: 0.6;
            font-size: 9px;
            page-break-before: avoid;
        }

        .doc-footer .doc-divider {
            margin: 0 0 4px 0;
        }

        .doc-footer-content {
            gap: 8px;
            margin-bottom: 2px;
        }

        .doc-footer-brand {
            gap: 2px;
            font-size: 9px;
        }

        .doc-footer-disclaimer {
            font-size: 9px;
            line-height: 1.2;
            margin: 0;
        }

        /* Section headings */
        .doc-page :global(.doc-section-heading) {
            font-size: 11px;
            margin: 0 0 6px 0;
            page-break-after: avoid;
        }
    }
</style>
